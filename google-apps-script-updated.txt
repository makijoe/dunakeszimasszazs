// ============================================
// Google Apps Script for Dunakeszi MasszÃ¡zs
// Booking System with Google Calendar Integration
// Supports Recurring Bookings, Cancellations, and Changes
// ============================================

function doPost(e) {
  try {
    // Check if e and e.postData exist
    if (!e || !e.postData || !e.postData.contents) {
      return createResponse(false, 'HiÃ¡nyzÃ³ adatok a kÃ©rÃ©sben');
    }
    
    // Parse the incoming JSON data
    var data = JSON.parse(e.postData.contents);
    
    // Handle different actions
    if (data.action === 'cancel') {
      return handleCancellation(data);
    } else if (data.action === 'change') {
      return handleChange(data);
    }
    
    // Default: Create new booking
    return createBooking(data);
    
  } catch (error) {
    console.error('Error in doPost:', error);
    return createResponse(false, 'Hiba tÃ¶rtÃ©nt a kÃ©rÃ©s feldolgozÃ¡sa kÃ¶zben: ' + error.message);
  }
}

function doGet(e) {
  return createResponse(true, 'Booking API is running. Use POST to create bookings.');
}

// ============================================
// Create New Booking
// ============================================
function createBooking(data) {
  // Validate required fields
  if (!data.name || !data.email || !data.service || !data.date || !data.time) {
    return createResponse(false, 'HiÃ¡nyzÃ³ kÃ¶telezÅ‘ mezÅ‘k (nÃ©v, email, kezelÃ©s, dÃ¡tum, idÅ‘pont)');
  }
  
  // Validate email format
  if (!data.email.includes('@') || !data.email.includes('.')) {
    return createResponse(false, 'Ã‰rvÃ©nytelen email cÃ­m');
  }
  
  // Get the default calendar
  var calendar = CalendarApp.getDefaultCalendar();
  
  // Parse date and create start time
  var dateParts = data.date.split('-');
  var timeParts = data.time.split(':');
  var baseStartTime = new Date(
    parseInt(dateParts[0]),
    parseInt(dateParts[1]) - 1,
    parseInt(dateParts[2]),
    parseInt(timeParts[0]),
    parseInt(timeParts[1])
  );
  
  // Calculate end time (60 min session)
  var baseEndTime = new Date(baseStartTime.getTime() + (60 * 60 * 1000));
  
  // Handle recurring bookings
  var recurringCount = data.recurring ? (data.recurringCount || 1) : 1;
  var recurringType = data.recurringType || 'weekly';
  var createdEvents = [];
  var recurringDates = [];
  
  // Calculate discount
  var discountPercent = 0;
  if (recurringCount >= 6) discountPercent = 15;
  else if (recurringCount >= 4) discountPercent = 10;
  else if (recurringCount >= 2) discountPercent = 5;
  
  for (var i = 0; i < recurringCount; i++) {
    var occurrenceStartTime = new Date(baseStartTime);
    var occurrenceEndTime = new Date(baseEndTime);
    
    if (i > 0) {
      if (recurringType === 'weekly') {
        occurrenceStartTime.setDate(occurrenceStartTime.getDate() + (i * 7));
        occurrenceEndTime.setDate(occurrenceEndTime.getDate() + (i * 7));
      } else if (recurringType === 'biweekly') {
        occurrenceStartTime.setDate(occurrenceStartTime.getDate() + (i * 14));
        occurrenceEndTime.setDate(occurrenceEndTime.getDate() + (i * 14));
      } else if (recurringType === 'monthly') {
        occurrenceStartTime.setMonth(occurrenceStartTime.getMonth() + i);
        occurrenceEndTime.setMonth(occurrenceEndTime.getMonth() + i);
      }
    }
    
    var dateStr = occurrenceStartTime.getFullYear() + '-' + 
                  String(occurrenceStartTime.getMonth() + 1).padStart(2, '0') + '-' + 
                  String(occurrenceStartTime.getDate()).padStart(2, '0');
    recurringDates.push(dateStr);
    
    var eventTitle = 'MasszÃ¡zs - ' + data.name + ' - ' + data.service;
    if (recurringCount > 1) {
      eventTitle += ' (' + (i + 1) + '/' + recurringCount + ')';
    }
    
    var event = calendar.createEvent(
      eventTitle,
      occurrenceStartTime,
      occurrenceEndTime,
      {
        description: 'KezelÃ©s: ' + data.service + '\n' +
                     'NÃ©v: ' + data.name + '\n' +
                     'Telefon: ' + (data.phone || 'Nincs megadva') + '\n' +
                     'Email: ' + data.email + '\n' +
                     'MegjegyzÃ©s: ' + (data.notes || 'Nincs megadva') + '\n' +
                     (recurringCount > 1 ? 'IsmÃ©tlÅ‘dÃ©s: ' + (i + 1) + '/' + recurringCount + '\n' : '') +
                     (discountPercent > 0 ? 'KedvezmÃ©ny: ' + discountPercent + '%\n' : ''),
        location: 'Angyali Szalon, Dunakeszi'
      }
    );
    
    event.setColor('6');
    createdEvents.push(event.getId());
  }
  
  // Send emails
  sendBookingConfirmationToEdina(data, recurringCount, recurringType, recurringDates, discountPercent);
  sendBookingConfirmationToCustomer(data, recurringCount, recurringType, recurringDates, discountPercent);
  
  return createResponse(true, 'FoglalÃ¡s sikeresen rÃ¶gzÃ­tve!', {
    eventIds: createdEvents,
    recurringCount: recurringCount,
    recurringDates: recurringDates,
    discountPercent: discountPercent
  });
}

// ============================================
// Handle Cancellation
// ============================================
function handleCancellation(data) {
  if (!data.clientName || !data.clientEmail || !data.appointmentDate || !data.appointmentTime) {
    return createResponse(false, 'HiÃ¡nyzÃ³ kÃ¶telezÅ‘ mezÅ‘k');
  }
  
  // Send cancellation email to customer
  var subject = 'IdÅ‘pont lemondva - Dunakeszi MasszÃ¡zs';
  var body = 'Kedves ' + data.clientName + '!\n\n' +
             'Ã‰rtesÃ­tjÃ¼k, hogy az alÃ¡bbi idÅ‘pontod lemondÃ¡sra kerÃ¼lt:\n\n' +
             'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n' +
             'ğŸ’† KezelÃ©s: ' + (data.service || 'Nincs megadva') + '\n' +
             'ğŸ“… DÃ¡tum: ' + data.appointmentDate + '\n' +
             'â° IdÅ‘pont: ' + data.appointmentTime + '\n' +
             'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n';
  
  if (data.reason) {
    body += 'IndoklÃ¡s: ' + data.reason + '\n\n';
  }
  
  body += 'Ha szeretnÃ©l Ãºj idÅ‘pontot foglalni, kÃ©rjÃ¼k, lÃ¡togass el a weboldalunkra vagy hÃ­vj telefonon.\n\n' +
          'ğŸ“ +36 30 487 7883\n' +
          'ğŸŒ https://dunakeszimasszazs.hu\n\n' +
          'ÃœdvÃ¶zlettel,\n' +
          'Makra Edina\n' +
          'Dunakeszi MasszÃ¡zs - Angyali Szalon';
  
  MailApp.sendEmail({
    to: data.clientEmail,
    subject: subject,
    body: body,
    name: 'Dunakeszi MasszÃ¡zs - Angyali Szalon'
  });
  
  // Send notification to Edina
  var edinaSubject = 'IdÅ‘pont lemondva - ' + data.clientName;
  var edinaBody = 'Kedves Edina!\n\n' +
                  'Egy idÅ‘pont lemondÃ¡sra kerÃ¼lt:\n\n' +
                  'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n' +
                  'ğŸ‘¤ NÃ©v: ' + data.clientName + '\n' +
                  'ğŸ“§ Email: ' + data.clientEmail + '\n' +
                  'ğŸ’† KezelÃ©s: ' + (data.service || 'Nincs megadva') + '\n' +
                  'ğŸ“… DÃ¡tum: ' + data.appointmentDate + '\n' +
                  'â° IdÅ‘pont: ' + data.appointmentTime + '\n' +
                  'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n';
  
  if (data.reason) {
    edinaBody += 'IndoklÃ¡s: ' + data.reason + '\n\n';
  }
  
  edinaBody += 'Ne felejtsd el tÃ¶rÃ¶lni az idÅ‘pontot a Google NaptÃ¡rbÃ³l!';
  
  MailApp.sendEmail({
    to: 'dunakeszimasszor@gmail.com',
    subject: edinaSubject,
    body: edinaBody,
    name: 'Dunakeszi MasszÃ¡zs - Admin'
  });
  
  return createResponse(true, 'LemondÃ¡si Ã©rtesÃ­tÃ©s elkÃ¼ldve!');
}

// ============================================
// Handle Change Notification
// ============================================
function handleChange(data) {
  if (!data.clientName || !data.clientEmail || !data.appointmentDate || !data.appointmentTime || !data.newDate || !data.newTime) {
    return createResponse(false, 'HiÃ¡nyzÃ³ kÃ¶telezÅ‘ mezÅ‘k');
  }
  
  // Send change email to customer
  var subject = 'IdÅ‘pont mÃ³dosÃ­tva - Dunakeszi MasszÃ¡zs';
  var body = 'Kedves ' + data.clientName + '!\n\n' +
             'Ã‰rtesÃ­tjÃ¼k, hogy az idÅ‘pontod mÃ³dosÃ­tÃ¡sra kerÃ¼lt:\n\n' +
             'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n' +
             'âŒ EREDETI IDÅPONT:\n' +
             'ğŸ“… DÃ¡tum: ' + data.appointmentDate + '\n' +
             'â° IdÅ‘pont: ' + data.appointmentTime + '\n\n' +
             'âœ… ÃšJ IDÅPONT:\n' +
             'ğŸ“… DÃ¡tum: ' + data.newDate + '\n' +
             'â° IdÅ‘pont: ' + data.newTime + '\n' +
             'ğŸ’† KezelÃ©s: ' + (data.service || 'Nincs megadva') + '\n' +
             'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n' +
             'ğŸ“ CÃM Ã‰S MEGKÃ–ZELÃTÃ‰S:\n' +
             'Dunakeszi, Kolonics GyÃ¶rgy utca 2/B, 2120\n' +
             'KapucsengÅ‘: 1/43\n\n' +
             'Ha kÃ©rdÃ©sed van, hÃ­vj bÃ¡tran:\n' +
             'ğŸ“ +36 30 487 7883\n\n' +
             'VÃ¡runk szeretettel az Angyali Szalonban!\n\n' +
             'ÃœdvÃ¶zlettel,\n' +
             'Makra Edina\n' +
             'Dunakeszi MasszÃ¡zs - Angyali Szalon';
  
  MailApp.sendEmail({
    to: data.clientEmail,
    subject: subject,
    body: body,
    name: 'Dunakeszi MasszÃ¡zs - Angyali Szalon'
  });
  
  // Send notification to Edina
  var edinaSubject = 'IdÅ‘pont mÃ³dosÃ­tva - ' + data.clientName;
  var edinaBody = 'Kedves Edina!\n\n' +
                  'Egy idÅ‘pont mÃ³dosÃ­tÃ¡sra kerÃ¼lt:\n\n' +
                  'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n' +
                  'ğŸ‘¤ NÃ©v: ' + data.clientName + '\n' +
                  'ğŸ“§ Email: ' + data.clientEmail + '\n' +
                  'ğŸ’† KezelÃ©s: ' + (data.service || 'Nincs megadva') + '\n\n' +
                  'âŒ EREDETI:\n' +
                  'ğŸ“… ' + data.appointmentDate + ' ' + data.appointmentTime + '\n\n' +
                  'âœ… ÃšJ:\n' +
                  'ğŸ“… ' + data.newDate + ' ' + data.newTime + '\n' +
                  'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n' +
                  'Ne felejtsd el frissÃ­teni az idÅ‘pontot a Google NaptÃ¡rbÃ³l!';
  
  MailApp.sendEmail({
    to: 'dunakeszimasszor@gmail.com',
    subject: edinaSubject,
    body: edinaBody,
    name: 'Dunakeszi MasszÃ¡zs - Admin'
  });
  
  return createResponse(true, 'MÃ³dosÃ­tÃ¡si Ã©rtesÃ­tÃ©s elkÃ¼ldve!');
}

// ============================================
// Send Booking Confirmation to Edina
// ============================================
function sendBookingConfirmationToEdina(data, recurringCount, recurringType, recurringDates, discountPercent) {
  var edinaSubject = recurringCount > 1 
    ? 'Ãšj ismÃ©tlÅ‘dÅ‘ foglalÃ¡s - ' + data.name + ' (' + recurringCount + ' alkalom)'
    : 'Ãšj idÅ‘pontfoglalÃ¡s - ' + data.name;
  
  var edinaBody = 'Kedves Edina!\n\n';
  
  if (recurringCount > 1) {
    edinaBody += 'Ãšj ISMÃ‰TLÅDÅ foglalÃ¡s Ã©rkezett a weboldalrÃ³l:\n\n';
    edinaBody += 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n';
    edinaBody += 'ğŸ‘¤ NÃ‰V: ' + data.name + '\n';
    edinaBody += 'ğŸ“ TELEFON: ' + (data.phone || 'Nincs megadva') + '\n';
    edinaBody += 'ğŸ“§ EMAIL: ' + data.email + '\n';
    edinaBody += 'ğŸ’† KEZELÃ‰S: ' + data.service + '\n';
    edinaBody += 'ğŸ“… ELSÅ DÃTUM: ' + data.date + '\n';
    edinaBody += 'â° IDÅPONT: ' + data.time + '\n';
    edinaBody += 'ğŸ”„ ISMÃ‰TLÅDÃ‰S: ' + getRecurringTypeText(recurringType) + '\n';
    edinaBody += 'ğŸ“Š ALKALMAK SZÃMA: ' + recurringCount + '\n';
    if (discountPercent > 0) {
      edinaBody += 'ğŸ’° KEDVEZMÃ‰NY: ' + discountPercent + '%\n';
    }
    edinaBody += 'ğŸ“‹ Ã–SSZES DÃTUM:\n';
    for (var j = 0; j < recurringDates.length; j++) {
      edinaBody += '   ' + (j + 1) + '. ' + recurringDates[j] + '\n';
    }
    edinaBody += 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n';
  } else {
    edinaBody += 'Ãšj idÅ‘pontfoglalÃ¡s Ã©rkezett a weboldalrÃ³l:\n\n';
    edinaBody += 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n';
    edinaBody += 'ğŸ‘¤ NÃ‰V: ' + data.name + '\n';
    edinaBody += 'ğŸ“ TELEFON: ' + (data.phone || 'Nincs megadva') + '\n';
    edinaBody += 'ğŸ“§ EMAIL: ' + data.email + '\n';
    edinaBody += 'ğŸ’† KEZELÃ‰S: ' + data.service + '\n';
    edinaBody += 'ğŸ“… DÃTUM: ' + data.date + '\n';
    edinaBody += 'â° IDÅPONT: ' + data.time + '\n';
    edinaBody += 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n';
  }
  
  edinaBody += 'ğŸ“ MEGJEGYZÃ‰S: ' + (data.notes || 'Nincs megadva') + '\n\n';
  edinaBody += 'A foglalÃ¡s(ok) automatikusan hozzÃ¡adva lettek a Google NaptÃ¡radhoz.\n\n';
  edinaBody += 'ÃœdvÃ¶zlettel,\n';
  edinaBody += 'Dunakeszi MasszÃ¡zs Weboldal';
  
  MailApp.sendEmail({
    to: 'dunakeszimasszor@gmail.com',
    subject: edinaSubject,
    body: edinaBody,
    name: 'Dunakeszi MasszÃ¡zs - FoglalÃ¡si Rendszer'
  });
}

// ============================================
// Send Booking Confirmation to Customer
// ============================================
function sendBookingConfirmationToCustomer(data, recurringCount, recurringType, recurringDates, discountPercent) {
  var customerSubject = recurringCount > 1
    ? 'IsmÃ©tlÅ‘dÅ‘ idÅ‘pontfoglalÃ¡s visszaigazolÃ¡s - Dunakeszi MasszÃ¡zs'
    : 'IdÅ‘pontfoglalÃ¡s visszaigazolÃ¡s - Dunakeszi MasszÃ¡zs';
  
  var customerBody = 'Kedves ' + data.name + '!\n\n';
  customerBody += 'KÃ¶szÃ¶njÃ¼k az idÅ‘pontfoglalÃ¡sodat!\n\n';
  
  if (recurringCount > 1) {
    customerBody += 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n';
    customerBody += 'ğŸ’† KEZELÃ‰S: ' + data.service + '\n';
    customerBody += 'ğŸ“… ELSÅ DÃTUM: ' + data.date + '\n';
    customerBody += 'â° IDÅPONT: ' + data.time + '\n';
    customerBody += 'ğŸ”„ ISMÃ‰TLÅDÃ‰S: ' + getRecurringTypeText(recurringType) + '\n';
    customerBody += 'ğŸ“Š ALKALMAK SZÃMA: ' + recurringCount + '\n';
    if (discountPercent > 0) {
      customerBody += 'ğŸ’° KEDVEZMÃ‰NY: ' + discountPercent + '%\n';
    }
    customerBody += 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n';
    customerBody += 'ğŸ“‹ AZ Ã–SSZES FOGLALT IDÅPONT:\n';
    for (var k = 0; k < recurringDates.length; k++) {
      customerBody += '   ' + (k + 1) + '. ' + recurringDates[k] + ' ' + data.time + '\n';
    }
    customerBody += '\n';
  } else {
    customerBody += 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n';
    customerBody += 'ğŸ’† KEZELÃ‰S: ' + data.service + '\n';
    customerBody += 'ğŸ“… DÃTUM: ' + data.date + '\n';
    customerBody += 'â° IDÅPONT: ' + data.time + '\n';
    customerBody += 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n';
  }
  
  customerBody += 'ğŸ“ CÃM Ã‰S MEGKÃ–ZELÃTÃ‰S:\n';
  customerBody += 'Dunakeszi, Kolonics GyÃ¶rgy utca 2/B, 2120\n';
  customerBody += 'KapucsengÅ‘: 1/43\n\n';
  customerBody += 'A kapunÃ¡l a 1/43-as kapucsengÅ‘t kell megnyomni.\n\n';
  
  if (recurringCount > 1) {
    customerBody += 'âš ï¸ FONTOS INFORMÃCIÃ“ ISMÃ‰TLÅDÅ FOGLALÃSHOZ:\n';
    customerBody += 'â€¢ Minden alkalom elÅ‘tt 24 Ã³rÃ¡val emlÃ©keztetÅ‘t kÃ¼ldÃ¼nk\n';
    customerBody += 'â€¢ Ha bÃ¡rmelyik alkalomra nem tudsz eljÃ¶nni, kÃ©rjÃ¼k, 24 Ã³rÃ¡val elÅ‘tte jelezd\n';
    customerBody += 'â€¢ Az idÅ‘pontok mÃ³dosÃ­thatÃ³k 24 Ã³ra elÅ‘tt ingyenesen\n';
    if (discountPercent > 0) {
      customerBody += 'â€¢ KedvezmÃ©ny: ' + discountPercent + '% a tÃ¶bb alkalmas foglalÃ¡sÃ©rt\n';
    }
    customerBody += '\n';
  }
  
  customerBody += 'Ha bÃ¡rmilyen kÃ©rdÃ©sed van, hÃ­vj bÃ¡tran:\n';
  customerBody += 'ğŸ“ +36 30 487 7883\n\n';
  customerBody += 'VÃ¡runk szeretettel az Angyali Szalonban!\n\n';
  customerBody += 'ÃœdvÃ¶zlettel,\n';
  customerBody += 'Makra Edina\n';
  customerBody += 'Dunakeszi MasszÃ¡zs - Angyali Szalon\n';
  customerBody += 'ğŸ“ +36 30 487 7883\n';
  customerBody += 'ğŸ“§ dunakeszimasszor@gmail.com\n';
  customerBody += 'ğŸŒ https://dunakeszimasszazs.hu';
  
  MailApp.sendEmail({
    to: data.email,
    subject: customerSubject,
    body: customerBody,
    name: 'Dunakeszi MasszÃ¡zs - Angyali Szalon'
  });
}

// ============================================
// Helper Functions
// ============================================
function createResponse(success, message, data) {
  var response = { success: success, message: message };
  if (data) { response.data = data; }
  
  var output = ContentService.createTextOutput(JSON.stringify(response));
  output.setMimeType(ContentService.MimeType.JSON);
  return output;
}

function getRecurringTypeText(type) {
  switch(type) {
    case 'weekly': return 'Minden hÃ©ten';
    case 'biweekly': return 'KÃ©thetente';
    case 'monthly': return 'Minden hÃ³napban';
    default: return type;
  }
}

// ============================================
// Test Function
// ============================================
function testBooking() {
  var mockEvent = {
    postData: {
      contents: JSON.stringify({
        name: 'Teszt VendÃ©g',
        phone: '+36 30 123 4567',
        email: 'test@example.com',
        service: 'FrissÃ­tÅ‘ masszÃ¡zs',
        date: '2025-03-01',
        time: '14:00',
        notes: 'Ez egy teszt foglalÃ¡s',
        recurring: true,
        recurringType: 'weekly',
        recurringCount: 4
      })
    }
  };
  
  var result = doPost(mockEvent);
  Logger.log('Test result: ' + result.getContent());
}
