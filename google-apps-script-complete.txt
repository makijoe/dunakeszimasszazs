// ============================================
// Google Apps Script for Dunakeszi Massz√°zs
// Complete Booking & Customer Management System
// With P&L Tracking and Session Package Management
// ============================================

// Sheet names
const SHEETS = {
  CUSTOMERS: 'Customers',
  SESSION_PACKAGES: 'SessionPackages',
  BOOKINGS: 'Bookings',
  FINANCIAL: 'Financial',
  PNL: 'PnL'
};

// ============================================
// Setup - Run this once to create sheets
// ============================================
function setupSheets() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  
  // Create Customers sheet
  let customersSheet = ss.getSheetByName(SHEETS.CUSTOMERS);
  if (!customersSheet) {
    customersSheet = ss.insertSheet(SHEETS.CUSTOMERS);
    customersSheet.appendRow([
      'CustomerID', 'Name', 'Email', 'Phone', 'CreatedDate', 
      'TotalSessionsPurchased', 'TotalSessionsUsed', 'TotalSessionsRemaining',
      'TotalSpent', 'Notes'
    ]);
    customersSheet.getRange(1, 1, 1, 10).setFontWeight('bold');
  }
  
  // Create Session Packages sheet
  let packagesSheet = ss.getSheetByName(SHEETS.SESSION_PACKAGES);
  if (!packagesSheet) {
    packagesSheet = ss.insertSheet(SHEETS.SESSION_PACKAGES);
    packagesSheet.appendRow([
      'PackageID', 'CustomerID', 'CustomerName', 'PurchaseDate', 
      'ServiceType', 'SessionsPurchased', 'SessionsUsed', 'SessionsRemaining',
      'OriginalPrice', 'DiscountPercent', 'DiscountAmount', 'FinalPrice',
      'DepositPaid', 'Status', 'Notes'
    ]);
    packagesSheet.getRange(1, 1, 1, 15).setFontWeight('bold');
  }
  
  // Create Bookings sheet
  let bookingsSheet = ss.getSheetByName(SHEETS.BOOKINGS);
  if (!bookingsSheet) {
    bookingsSheet = ss.insertSheet(SHEETS.BOOKINGS);
    bookingsSheet.appendRow([
      'BookingID', 'CustomerID', 'CustomerName', 'Service', 
      'Date', 'Time', 'Status', 'PackageID', 'SessionNumber',
      'CreatedDate', 'Notes'
    ]);
    bookingsSheet.getRange(1, 1, 1, 11).setFontWeight('bold');
  }
  
  // Create Financial Transactions sheet
  let financialSheet = ss.getSheetByName(SHEETS.FINANCIAL);
  if (!financialSheet) {
    financialSheet = ss.insertSheet(SHEETS.FINANCIAL);
    financialSheet.appendRow([
      'TransactionID', 'Date', 'Type', 'CustomerID', 'CustomerName',
      'Description', 'Amount', 'PaymentMethod', 'RelatedPackageID', 'Notes'
    ]);
    financialSheet.getRange(1, 1, 1, 10).setFontWeight('bold');
  }
  
  // Create P&L Summary sheet
  let pnlSheet = ss.getSheetByName(SHEETS.PNL);
  if (!pnlSheet) {
    pnlSheet = ss.insertSheet(SHEETS.PNL);
    pnlSheet.appendRow(['Dunakeszi Massz√°zs - P&L Dashboard']);
    pnlSheet.appendRow(['']);
    pnlSheet.appendRow(['Monthly Summary']);
    pnlSheet.appendRow(['Month', 'Total Income', 'Total Deposits', 'Outstanding', 'Sessions Completed']);
    pnlSheet.getRange(3, 1, 2, 5).setFontWeight('bold');
  }
  
  return 'Sheets created successfully!';
}

// ============================================
// Main POST Handler
// ============================================
function doPost(e) {
  try {
    var data = {};
    
    // Google Apps Script form data is in e.parameter
    if (e && e.parameter && e.parameter.action) {
      data = e.parameter;
    } else if (e && e.postData && e.postData.contents) {
      // Try to parse as JSON
      try {
        data = JSON.parse(e.postData.contents);
      } catch (jsonError) {
        // If not JSON, parse as form data string
        var formData = e.postData.contents;
        var pairs = formData.split('&');
        for (var i = 0; i < pairs.length; i++) {
          var pair = pairs[i].split('=');
          if (pair.length === 2) {
            data[decodeURIComponent(pair[0])] = decodeURIComponent(pair[1].replace(/\+/g, ' '));
          }
        }
      }
    }
    
    if (!data.action) {
      return createHtmlResponse('<h1>Hiba</h1><p>Hi√°nyz√≥ m≈±velet</p>');
    }
    
    switch(data.action) {
      case 'ping':
        return createResponse(true, 'pong');
      case 'createBooking':
        return createBooking(data);
      case 'purchasePackage':
        return purchasePackage(data);
      case 'useSession':
        return useSession(data);
      case 'getCustomerProfile':
        return getCustomerProfile(data);
      case 'getAllCustomers':
        return getAllCustomers();
      case 'getPnL':
        return getPnL(data);
      case 'cancel':
        return handleCancellation(data);
      case 'change':
        return handleChange(data);
      case 'createStripeCheckout':
        return createStripeCheckout(data);
      case 'createStripeCheckoutDebug':
        return createStripeCheckoutDebug(data);
      default:
        return createHtmlResponse('<h1>Hiba</h1><p>Ismeretlen m≈±velet: ' + data.action + '</p>');
    }
  } catch (error) {
    console.error('Error in doPost:', error);
    return createHtmlResponse('<h1>Hiba</h1><p>' + error.message + '</p>');
  }
}

// ============================================
// GET Handler for Dashboard Data
// ============================================
function doGet(e) {
  try {
    var action = e.parameter.action;
    
    switch(action) {
      case 'dashboard':
        return getDashboardData();
      case 'customer':
        return getCustomerProfile({ email: e.parameter.email });
      case 'pnl':
        return getPnL({ month: e.parameter.month, year: e.parameter.year });
      default:
        return createResponse(true, 'API is running', { 
          endpoints: ['dashboard', 'customer', 'pnl'] 
        });
    }
  } catch (error) {
    return createResponse(false, 'Hiba: ' + error.message);
  }
}

// ============================================
// Create New Booking with Session Tracking
// ============================================
function createBooking(data) {
  // Validate required fields
  if (!data.name || !data.email || !data.service || !data.date || !data.time) {
    return createResponse(false, 'Hi√°nyz√≥ k√∂telez≈ë mez≈ëk');
  }
  
  var customer = getOrCreateCustomer(data.name, data.email, data.phone);
  var customerId = customer.customerId;
  
  // Check if customer has active session package
  var activePackage = findActivePackage(customerId, data.service);
  
  var packageId = null;
  var sessionNumber = null;
  
  // If using session from package
  if (data.usePackage && activePackage) {
    var useResult = deductSessionFromPackage(activePackage.packageId);
    if (useResult.success) {
      packageId = activePackage.packageId;
      sessionNumber = useResult.sessionNumber;
    }
  }
  
  // Create calendar event
  var calendar = CalendarApp.getDefaultCalendar();
  var dateParts = data.date.split('-');
  var timeParts = data.time.split(':');
  var startTime = new Date(
    parseInt(dateParts[0]), parseInt(dateParts[1]) - 1, parseInt(dateParts[2]),
    parseInt(timeParts[0]), parseInt(timeParts[1])
  );
  var endTime = new Date(startTime.getTime() + (60 * 60 * 1000));
  
  // Handle recurring bookings
  var recurringCount = data.recurring ? (data.recurringCount || 1) : 1;
  var recurringType = data.recurringType || 'weekly';
  var createdEvents = [];
  var recurringDates = [];
  
  var discountPercent = calculateDiscount(recurringCount);
  
  for (var i = 0; i < recurringCount; i++) {
    var occurrenceStart = new Date(startTime);
    var occurrenceEnd = new Date(endTime);
    
    if (i > 0) {
      if (recurringType === 'weekly') {
        occurrenceStart.setDate(occurrenceStart.getDate() + (i * 7));
        occurrenceEnd.setDate(occurrenceEnd.getDate() + (i * 7));
      } else if (recurringType === 'biweekly') {
        occurrenceStart.setDate(occurrenceStart.getDate() + (i * 14));
        occurrenceEnd.setDate(occurrenceEnd.getDate() + (i * 14));
      } else if (recurringType === 'monthly') {
        occurrenceStart.setMonth(occurrenceStart.getMonth() + i);
        occurrenceEnd.setMonth(occurrenceEnd.getMonth() + i);
      }
    }
    
    var dateStr = formatDate(occurrenceStart);
    recurringDates.push(dateStr);
    
    // Create calendar event
    var eventTitle = 'Massz√°zs - ' + data.name + ' - ' + data.service;
    if (recurringCount > 1) eventTitle += ' (' + (i + 1) + '/' + recurringCount + ')';
    if (packageId) eventTitle += ' [B√©rlet]';
    
    var event = calendar.createEvent(eventTitle, occurrenceStart, occurrenceEnd, {
      description: buildEventDescription(data, i + 1, recurringCount, packageId, sessionNumber),
      location: 'Angyali Szalon, Dunakeszi'
    });
    event.setColor(packageId ? '2' : '6'); // Green for package sessions, orange for regular
    createdEvents.push(event.getId());
    
    // Record booking
    recordBooking(customerId, data.name, data.service, dateStr, data.time, packageId, sessionNumber);
  }
  
  // Send confirmation emails
  sendBookingConfirmationToEdina(data, recurringCount, recurringType, recurringDates, discountPercent, packageId);
  sendBookingConfirmationToCustomer(data, recurringCount, recurringType, recurringDates, discountPercent, packageId, customer);
  
  return createResponse(true, 'Foglal√°s sikeresen r√∂gz√≠tve!', {
    customerId: customerId,
    eventIds: createdEvents,
    recurringCount: recurringCount,
    recurringDates: recurringDates,
    discountPercent: discountPercent,
    packageUsed: packageId !== null,
    customerProfile: customer
  });
}

// ============================================
// Purchase Session Package
// ============================================
function purchasePackage(data) {
  if (!data.customerId && !data.email) {
    return createResponse(false, 'CustomerID vagy email sz√ºks√©ges');
  }
  
  var customer;
  if (data.customerId) {
    customer = getCustomerById(data.customerId);
  } else {
    customer = getOrCreateCustomer(data.name, data.email, data.phone);
  }
  
  if (!customer) {
    return createResponse(false, 'V√°s√°rl√≥ nem tal√°lhat√≥');
  }
  
  var packageId = 'PKG' + Date.now();
  var purchaseDate = new Date();
  
  var sessionsPurchased = data.sessions || 12;
  var originalPrice = data.originalPrice || (sessionsPurchased * 15000);
  var discountPercent = calculateDiscount(sessionsPurchased);
  var discountAmount = Math.round(originalPrice * (discountPercent / 100));
  var finalPrice = originalPrice - discountAmount;
  var depositPaid = data.depositPaid || Math.round(finalPrice * 0.2);
  
  // Record package
  var packagesSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEETS.SESSION_PACKAGES);
  packagesSheet.appendRow([
    packageId,
    customer.customerId,
    customer.name,
    formatDate(purchaseDate),
    data.service || 'B√°rmely kezel√©s',
    sessionsPurchased,
    0, // sessions used
    sessionsPurchased, // sessions remaining
    originalPrice,
    discountPercent,
    discountAmount,
    finalPrice,
    depositPaid,
    'Active',
    data.notes || ''
  ]);
  
  // Record financial transaction
  recordTransaction(purchaseDate, 'Deposit', customer.customerId, customer.name, 
    'B√©rlet foglal√≥ (' + sessionsPurchased + ' alkalom)', depositPaid, 'Bank Transfer', packageId);
  
  // Update customer totals
  updateCustomerSessionTotals(customer.customerId);
  
  // Send confirmation email
  sendPackagePurchaseConfirmation(customer, {
    packageId: packageId,
    sessions: sessionsPurchased,
    originalPrice: originalPrice,
    discountPercent: discountPercent,
    discountAmount: discountAmount,
    finalPrice: finalPrice,
    depositPaid: depositPaid
  });
  
  return createResponse(true, 'B√©rlet sikeresen l√©trehozva!', {
    packageId: packageId,
    customerId: customer.customerId,
    sessionsPurchased: sessionsPurchased,
    finalPrice: finalPrice,
    depositPaid: depositPaid
  });
}

// ============================================
// Use/Deduct Session from Package
// ============================================
function useSession(data) {
  if (!data.packageId && !data.customerId) {
    return createResponse(false, 'PackageID vagy CustomerID sz√ºks√©ges');
  }
  
  var package;
  if (data.packageId) {
    package = getPackageById(data.packageId);
  } else {
    package = findActivePackage(data.customerId, data.service);
  }
  
  if (!package || package.sessionsRemaining <= 0) {
    return createResponse(false, 'Nincs akt√≠v b√©rlet vagy elfogytak az alkalmak');
  }
  
  return deductSessionFromPackage(package.packageId);
}

function deductSessionFromPackage(packageId) {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var packagesSheet = ss.getSheetByName(SHEETS.SESSION_PACKAGES);
  var data = packagesSheet.getDataRange().getValues();
  
  for (var i = 1; i < data.length; i++) {
    if (data[i][0] === packageId) {
      var sessionsUsed = data[i][6] + 1;
      var sessionsRemaining = data[i][5] - sessionsUsed;
      
      packagesSheet.getRange(i + 1, 7).setValue(sessionsUsed);
      packagesSheet.getRange(i + 1, 8).setValue(sessionsRemaining);
      
      if (sessionsRemaining <= 0) {
        packagesSheet.getRange(i + 1, 14).setValue('Completed');
      }
      
      // Update customer totals
      updateCustomerSessionTotals(data[i][1]);
      
      return {
        success: true,
        packageId: packageId,
        sessionNumber: sessionsUsed,
        sessionsRemaining: sessionsRemaining
      };
    }
  }
  
  return { success: false, message: 'B√©rlet nem tal√°lhat√≥' };
}

// ============================================
// Customer Management
// ============================================
function getOrCreateCustomer(name, email, phone) {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var customersSheet = ss.getSheetByName(SHEETS.CUSTOMERS);
  var data = customersSheet.getDataRange().getValues();
  
  // Search by email
  for (var i = 1; i < data.length; i++) {
    if (data[i][2] === email) {
      return {
        customerId: data[i][0],
        name: data[i][1],
        email: data[i][2],
        phone: data[i][3],
        createdDate: data[i][4],
        totalSessionsPurchased: data[i][5],
        totalSessionsUsed: data[i][6],
        totalSessionsRemaining: data[i][7],
        totalSpent: data[i][8],
        notes: data[i][9],
        isNew: false
      };
    }
  }
  
  // Create new customer
  var customerId = 'CUST' + Date.now();
  var createdDate = new Date();
  
  customersSheet.appendRow([
    customerId,
    name,
    email,
    phone || '',
    formatDate(createdDate),
    0, 0, 0, 0, ''
  ]);
  
  return {
    customerId: customerId,
    name: name,
    email: email,
    phone: phone || '',
    createdDate: formatDate(createdDate),
    totalSessionsPurchased: 0,
    totalSessionsUsed: 0,
    totalSessionsRemaining: 0,
    totalSpent: 0,
    notes: '',
    isNew: true
  };
}

function getCustomerById(customerId) {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var customersSheet = ss.getSheetByName(SHEETS.CUSTOMERS);
  var data = customersSheet.getDataRange().getValues();
  
  for (var i = 1; i < data.length; i++) {
    if (data[i][0] === customerId) {
      return {
        customerId: data[i][0],
        name: data[i][1],
        email: data[i][2],
        phone: data[i][3],
        createdDate: data[i][4],
        totalSessionsPurchased: data[i][5],
        totalSessionsUsed: data[i][6],
        totalSessionsRemaining: data[i][7],
        totalSpent: data[i][8],
        notes: data[i][9]
      };
    }
  }
  return null;
}

function getCustomerProfile(data) {
  if (!data.email && !data.customerId) {
    return createResponse(false, 'Email vagy CustomerID sz√ºks√©ges');
  }
  
  var customer;
  if (data.customerId) {
    customer = getCustomerById(data.customerId);
  } else {
    var result = getOrCreateCustomer(data.name || '', data.email, data.phone || '');
    customer = result;
  }
  
  if (!customer) {
    return createResponse(false, 'V√°s√°rl√≥ nem tal√°lhat√≥');
  }
  
  // Get active packages
  var packages = getCustomerPackages(customer.customerId);
  
  // Get booking history
  var bookings = getCustomerBookings(customer.customerId);
  
  return createResponse(true, 'Profil bet√∂ltve', {
    customer: customer,
    activePackages: packages.filter(p => p.status === 'Active'),
    completedPackages: packages.filter(p => p.status === 'Completed'),
    recentBookings: bookings.slice(0, 10),
    allBookings: bookings
  });
}

function getAllCustomers() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var customersSheet = ss.getSheetByName(SHEETS.CUSTOMERS);
  var data = customersSheet.getDataRange().getValues();
  
  var customers = [];
  for (var i = 1; i < data.length; i++) {
    customers.push({
      customerId: data[i][0],
      name: data[i][1],
      email: data[i][2],
      phone: data[i][3],
      totalSessionsRemaining: data[i][7],
      totalSpent: data[i][8]
    });
  }
  
  return createResponse(true, 'V√°s√°rl√≥k list√°ja', { customers: customers });
}

function getCustomerPackages(customerId) {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var packagesSheet = ss.getSheetByName(SHEETS.SESSION_PACKAGES);
  var data = packagesSheet.getDataRange().getValues();
  
  var packages = [];
  for (var i = 1; i < data.length; i++) {
    if (data[i][1] === customerId) {
      packages.push({
        packageId: data[i][0],
        purchaseDate: data[i][3],
        serviceType: data[i][4],
        sessionsPurchased: data[i][5],
        sessionsUsed: data[i][6],
        sessionsRemaining: data[i][7],
        originalPrice: data[i][8],
        discountPercent: data[i][9],
        discountAmount: data[i][10],
        finalPrice: data[i][11],
        depositPaid: data[i][12],
        status: data[i][13]
      });
    }
  }
  return packages;
}

function getCustomerBookings(customerId) {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var bookingsSheet = ss.getSheetByName(SHEETS.BOOKINGS);
  var data = bookingsSheet.getDataRange().getValues();
  
  var bookings = [];
  for (var i = 1; i < data.length; i++) {
    if (data[i][1] === customerId) {
      bookings.push({
        bookingId: data[i][0],
        service: data[i][3],
        date: data[i][4],
        time: data[i][5],
        status: data[i][6],
        packageId: data[i][7],
        sessionNumber: data[i][8]
      });
    }
  }
  return bookings.reverse(); // Most recent first
}

function findActivePackage(customerId, serviceType) {
  var packages = getCustomerPackages(customerId);
  
  for (var i = 0; i < packages.length; i++) {
    if (packages[i].status === 'Active' && packages[i].sessionsRemaining > 0) {
      // Check if service matches or package is for any service
      if (packages[i].serviceType === 'B√°rmely kezel√©s' || 
          packages[i].serviceType === serviceType ||
          !serviceType) {
        return packages[i];
      }
    }
  }
  return null;
}

function getPackageById(packageId) {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var packagesSheet = ss.getSheetByName(SHEETS.SESSION_PACKAGES);
  var data = packagesSheet.getDataRange().getValues();
  
  for (var i = 1; i < data.length; i++) {
    if (data[i][0] === packageId) {
      return {
        packageId: data[i][0],
        customerId: data[i][1],
        sessionsPurchased: data[i][5],
        sessionsUsed: data[i][6],
        sessionsRemaining: data[i][7],
        status: data[i][13]
      };
    }
  }
  return null;
}

function updateCustomerSessionTotals(customerId) {
  var packages = getCustomerPackages(customerId);
  
  var totalPurchased = 0;
  var totalUsed = 0;
  var totalSpent = 0;
  
  for (var i = 0; i < packages.length; i++) {
    totalPurchased += packages[i].sessionsPurchased;
    totalUsed += packages[i].sessionsUsed;
    totalSpent += packages[i].finalPrice;
  }
  
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var customersSheet = ss.getSheetByName(SHEETS.CUSTOMERS);
  var data = customersSheet.getDataRange().getValues();
  
  for (var j = 1; j < data.length; j++) {
    if (data[j][0] === customerId) {
      customersSheet.getRange(j + 1, 6).setValue(totalPurchased);
      customersSheet.getRange(j + 1, 7).setValue(totalUsed);
      customersSheet.getRange(j + 1, 8).setValue(totalPurchased - totalUsed);
      customersSheet.getRange(j + 1, 9).setValue(totalSpent);
      break;
    }
  }
}

// ============================================
// Stripe Checkout Integration
// ============================================

// Stripe keys are read from Script Properties for security.
// Set these in Apps Script: Project Settings ‚Üí Script properties
const STRIPE_SECRET_KEY = PropertiesService.getScriptProperties().getProperty('STRIPE_SECRET_KEY') || '';
const STRIPE_PUBLISHABLE_KEY = PropertiesService.getScriptProperties().getProperty('STRIPE_PUBLISHABLE_KEY') || '';
const STRIPE_WEBHOOK_SECRET = PropertiesService.getScriptProperties().getProperty('STRIPE_WEBHOOK_SECRET') || '';

function createStripeCheckout(data) {
  try {
    // Validate required fields
    if (!data.name || !data.email || (data.amount === undefined || data.amount === null)) {
      return createHtmlResponse('<h1>Hiba</h1><p>Hi√°nyz√≥ k√∂telez≈ë mez≈ëk (n√©v, email, √∂sszeg)</p>');
    }
    
    var amount = parseInt(data.amount);
    
    // Safety check: Stripe minimum for HUF is 175 Ft.
    // If amount is 0, NaN, or too low, use a default 3000 Ft deposit.
    if (!amount || amount < 175 || isNaN(amount)) {
      amount = 3000;
      Logger.log('Backend warning: Amount was too low (' + data.amount + '), forcing 3000 Ft');
    }
    
    var serviceName = data.service || 'Massz√°zs kezel√©s';
    var recurringText = data.recurring === 'yes' ? ' (' + data.recurringCount + ' alkalom)' : '';
    
    // Build form-encoded payload for Stripe API
    // Stripe requires application/x-www-form-urlencoded format
    var payload = 
      'mode=payment' +
      '&line_items[0][price_data][currency]=huf' +
      '&line_items[0][price_data][product_data][name]=' + encodeURIComponent('Foglal√°si d√≠j - ' + serviceName + recurringText) +
      '&line_items[0][price_data][product_data][description]=' + encodeURIComponent('Dunakeszi Massz√°zs - Angyali Szalon foglal√°si d√≠j') +
      '&line_items[0][price_data][unit_amount]=' + amount + // HUF is a zero-decimal currency; pass integer forints
      '&line_items[0][quantity]=1' +
      '&customer_email=' + encodeURIComponent(data.email) +
      '&success_url=' + encodeURIComponent(data.successUrl || 'https://dunakeszimasszazs.hu/#booking-success') +
      '&cancel_url=' + encodeURIComponent(data.cancelUrl || 'https://dunakeszimasszazs.hu/#booking-cancel') +
      '&metadata[customer_name]=' + encodeURIComponent(data.name) +
      '&metadata[customer_email]=' + encodeURIComponent(data.email) +
      '&metadata[service]=' + encodeURIComponent(data.service || '') +
      '&metadata[date]=' + encodeURIComponent(data.date || '') +
      '&metadata[time]=' + encodeURIComponent(data.time || '') +
      '&metadata[recurring]=' + encodeURIComponent(data.recurring || 'no') +
      '&metadata[recurring_count]=' + encodeURIComponent(data.recurringCount || '1');
    
    var options = {
      method: 'POST',
      headers: {
        'Authorization': 'Bearer ' + STRIPE_SECRET_KEY,
        'Content-Type': 'application/x-www-form-urlencoded'
      },
      payload: payload,
      muteHttpExceptions: true // This allows us to see the full error response
    };
    
    var response = UrlFetchApp.fetch('https://api.stripe.com/v1/checkout/sessions', options);
    var responseCode = response.getResponseCode();
    var result = JSON.parse(response.getContentText());
    
    if (responseCode === 200 && result.url) {
      // Store pending booking data
      storePendingBooking(data);
      
      // Return JSON with the URL instead of HTML
      // This is more reliable for AJAX/Fetch calls from the website
      return createResponse(true, 'Booking recorded, redirect to Stripe', { url: result.url });
    } else {
      // Log the full error for debugging
      Logger.log('Stripe error: ' + JSON.stringify(result));
      return createResponse(false, 'Hiba a Stripe checkout l√©trehoz√°sakor: ' + (result.error ? result.error.message : 'Ismeretlen hiba (HTTP ' + responseCode + ')'));
    }
    
  } catch (error) {
    Logger.log('Stripe checkout error: ' + error);
    return createResponse(false, 'Hiba a Stripe checkout sor√°n: ' + error.message);
  }
}

/**
 * Debug helper: creates a Stripe Checkout session and returns the raw Stripe response as JSON.
 * Use this for testing via curl/postman. Does not store pending booking or redirect.
 */
function createStripeCheckoutDebug(data) {
  try {
    if (!data.email || (data.amount === undefined || data.amount === null)) {
      return createResponse(false, 'Missing required fields: email and amount');
    }

    var amount = parseInt(data.amount);
    
    // Safety check: Stripe minimum for HUF is 175 Ft.
    if (!amount || amount < 175 || isNaN(amount)) {
      amount = 3000;
      Logger.log('Debug backend warning: Amount too low (' + data.amount + '), using 3000 Ft');
    }
    
    var serviceName = data.service || 'Massz√°zs kezel√©s';
    var recurringText = data.recurring === 'yes' ? ' (' + data.recurringCount + ' alkalom)' : '';

    var payload = 
      'mode=payment' +
      '&line_items[0][price_data][currency]=huf' +
      '&line_items[0][price_data][product_data][name]=' + encodeURIComponent('Foglal√°si d√≠j - ' + serviceName + recurringText) +
      '&line_items[0][price_data][product_data][description]=' + encodeURIComponent('Dunakeszi Massz√°zs - Angyali Szalon foglal√°si d√≠j') +
      '&line_items[0][price_data][unit_amount]=' + amount +
      '&line_items[0][quantity]=1' +
      '&customer_email=' + encodeURIComponent(data.email) +
      '&success_url=' + encodeURIComponent(data.successUrl || 'https://dunakeszimasszazs.hu/#booking-success') +
      '&cancel_url=' + encodeURIComponent(data.cancelUrl || 'https://dunakeszimasszazs.hu/#booking-cancel') +
      '&metadata[customer_name]=' + encodeURIComponent(data.name || '') +
      '&metadata[customer_email]=' + encodeURIComponent(data.email || '') +
      '&metadata[service]=' + encodeURIComponent(data.service || '') +
      '&metadata[date]=' + encodeURIComponent(data.date || '') +
      '&metadata[time]=' + encodeURIComponent(data.time || '') +
      '&metadata[recurring]=' + encodeURIComponent(data.recurring || 'no') +
      '&metadata[recurring_count]=' + encodeURIComponent(data.recurringCount || '1');

    var options = {
      method: 'POST',
      headers: {
        'Authorization': 'Bearer ' + STRIPE_SECRET_KEY,
        'Content-Type': 'application/x-www-form-urlencoded'
      },
      payload: payload,
      muteHttpExceptions: true
    };

    var response = UrlFetchApp.fetch('https://api.stripe.com/v1/checkout/sessions', options);
    var responseCode = response.getResponseCode();
    var resultText = response.getContentText();
    var result = {};
    try { result = JSON.parse(resultText); } catch (e) { result = { raw: resultText }; }

    return createResponse(true, 'Stripe API response', { status: responseCode, body: result });
  } catch (err) {
    return createResponse(false, 'Debug error: ' + err.message);
  }
}

/**
 * Convenience helper to set Stripe keys into Script Properties from the editor.
 * Run this in the Apps Script editor after replacing the placeholder values with your keys.
 */
function setStripeProperties() {
  var props = PropertiesService.getScriptProperties();
  props.setProperties({
    STRIPE_SECRET_KEY: 'sk_test_REPLACE_WITH_YOURS',
    STRIPE_PUBLISHABLE_KEY: 'pk_test_REPLACE_WITH_YOURS',
    STRIPE_WEBHOOK_SECRET: 'whsec_REPLACE_WITH_YOURS'
  });
  Logger.log('Stripe script properties set (replace placeholders with real keys if needed).');
}

function storePendingBooking(data) {
  // Store booking data temporarily until payment is confirmed
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var pendingSheet = ss.getSheetByName('PendingBookings');
  
  if (!pendingSheet) {
    pendingSheet = ss.insertSheet('PendingBookings');
    pendingSheet.appendRow([
      'Timestamp', 'Name', 'Email', 'Phone', 'Service', 'Date', 'Time', 
      'Notes', 'Recurring', 'RecurringType', 'RecurringCount', 'Amount', 'Status'
    ]);
    pendingSheet.getRange(1, 1, 1, 13).setFontWeight('bold');
  }
  
  pendingSheet.appendRow([
    new Date(),
    data.name,
    data.email,
    data.phone || '',
    data.service,
    data.date,
    data.time,
    data.notes || '',
    data.recurring ? 'yes' : 'no',
    data.recurringType || '',
    data.recurringCount || 1,
    data.amount,
    'pending'
  ]);
}

// ============================================
// Record Booking
// ============================================
function recordBooking(customerId, customerName, service, date, time, packageId, sessionNumber) {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var bookingsSheet = ss.getSheetByName(SHEETS.BOOKINGS);
  
  var bookingId = 'BK' + Date.now() + Math.random().toString(36).substr(2, 5);
  
  bookingsSheet.appendRow([
    bookingId,
    customerId,
    customerName,
    service,
    date,
    time,
    'Confirmed',
    packageId || '',
    sessionNumber || '',
    formatDate(new Date()),
    ''
  ]);
  
  return bookingId;
}

// ============================================
// Financial Tracking
// ============================================
function recordTransaction(date, type, customerId, customerName, description, amount, paymentMethod, relatedId) {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var financialSheet = ss.getSheetByName(SHEETS.FINANCIAL);
  
  var transactionId = 'TXN' + Date.now();
  
  financialSheet.appendRow([
    transactionId,
    formatDate(date),
    type,
    customerId || '',
    customerName || '',
    description,
    amount,
    paymentMethod || '',
    relatedId || '',
    ''
  ]);
  
  return transactionId;
}

// ============================================
// P&L Dashboard
// ============================================
function getPnL(data) {
  var month = data.month || new Date().getMonth() + 1;
  var year = data.year || new Date().getFullYear();
  
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var financialSheet = ss.getSheetByName(SHEETS.FINANCIAL);
  var data = financialSheet.getDataRange().getValues();
  
  var monthlyIncome = 0;
  var monthlyDeposits = 0;
  var monthlyOutstanding = 0;
  
  var transactions = [];
  
  for (var i = 1; i < data.length; i++) {
    var txnDate = new Date(data[i][1]);
    if (txnDate.getMonth() + 1 === parseInt(month) && txnDate.getFullYear() === parseInt(year)) {
      var amount = data[i][6];
      var type = data[i][2];
      
      if (type === 'Income' || type === 'Payment') {
        monthlyIncome += amount;
      } else if (type === 'Deposit') {
        monthlyDeposits += amount;
      }
      
      transactions.push({
        date: data[i][1],
        type: type,
        customer: data[i][4],
        description: data[i][5],
        amount: amount
      });
    }
  }
  
  // Get session stats
  var bookingsSheet = ss.getSheetByName(SHEETS.BOOKINGS);
  var bookingsData = bookingsSheet.getDataRange().getValues();
  var sessionsCompleted = 0;
  
  for (var j = 1; j < bookingsData.length; j++) {
    var bookingDate = new Date(bookingsData[j][4]);
    if (bookingDate.getMonth() + 1 === parseInt(month) && 
        bookingDate.getFullYear() === parseInt(year) &&
        bookingsData[j][6] === 'Confirmed') {
      sessionsCompleted++;
    }
  }
  
  return createResponse(true, 'P&L adatok', {
    month: month,
    year: year,
    totalIncome: monthlyIncome,
    totalDeposits: monthlyDeposits,
    outstanding: monthlyIncome - monthlyDeposits,
    sessionsCompleted: sessionsCompleted,
    transactions: transactions
  });
}

function getDashboardData() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  
  // Get customer count
  var customersSheet = ss.getSheetByName(SHEETS.CUSTOMERS);
  var customerCount = customersSheet.getLastRow() - 1;
  
  // Get active packages count
  var packagesSheet = ss.getSheetByName(SHEETS.SESSION_PACKAGES);
  var packagesData = packagesSheet.getDataRange().getValues();
  var activePackages = 0;
  var totalSessionsRemaining = 0;
  
  for (var i = 1; i < packagesData.length; i++) {
    if (packagesData[i][13] === 'Active') {
      activePackages++;
      totalSessionsRemaining += packagesData[i][7];
    }
  }
  
  // Get today's bookings
  var bookingsSheet = ss.getSheetByName(SHEETS.BOOKINGS);
  var bookingsData = bookingsSheet.getDataRange().getValues();
  var today = formatDate(new Date());
  var todaysBookings = [];
  
  for (var j = 1; j < bookingsData.length; j++) {
    if (bookingsData[j][4] === today) {
      todaysBookings.push({
        customer: bookingsData[j][2],
        service: bookingsData[j][3],
        time: bookingsData[j][5]
      });
    }
  }
  
  // Get current month P&L
  var pnlData = getPnL({ month: new Date().getMonth() + 1, year: new Date().getFullYear() });
  
  return createResponse(true, 'Dashboard adatok', {
    customerCount: customerCount,
    activePackages: activePackages,
    totalSessionsRemaining: totalSessionsRemaining,
    todaysBookings: todaysBookings,
    monthlyPnL: pnlData.data
  });
}

// ============================================
// Cancellation & Change Handlers
// ============================================
function handleCancellation(data) {
  if (!data.clientName || !data.clientEmail || !data.appointmentDate || !data.appointmentTime) {
    return createResponse(false, 'Hi√°nyz√≥ k√∂telez≈ë mez≈ëk');
  }
  
  // Send cancellation email to customer
  var subject = 'Id≈ëpont lemondva - Dunakeszi Massz√°zs';
  var body = 'Kedves ' + data.clientName + '!\n\n' +
             '√ârtes√≠tj√ºk, hogy az al√°bbi id≈ëpontod lemond√°sra ker√ºlt:\n\n' +
             '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n' +
             'üíÜ Kezel√©s: ' + (data.service || 'Nincs megadva') + '\n' +
             'üìÖ D√°tum: ' + data.appointmentDate + '\n' +
             '‚è∞ Id≈ëpont: ' + data.appointmentTime + '\n' +
             '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n';
  
  if (data.reason) {
    body += 'Indokl√°s: ' + data.reason + '\n\n';
  }
  
  body += 'Ha szeretn√©l √∫j id≈ëpontot foglalni, k√©rj√ºk, l√°togass el a weboldalunkra vagy h√≠vj telefonon.\n\n' +
          'üìû +36 30 487 7883\n' +
          'üåê https://dunakeszimasszazs.hu\n\n' +
          '√údv√∂zlettel,\n' +
          'Makra Edina\n' +
          'Dunakeszi Massz√°zs - Angyali Szalon';
  
  MailApp.sendEmail({
    to: data.clientEmail,
    subject: subject,
    body: body,
    name: 'Dunakeszi Massz√°zs - Angyali Szalon'
  });
  
  // Send notification to Edina
  var edinaSubject = 'Id≈ëpont lemondva - ' + data.clientName;
  var edinaBody = 'Kedves Edina!\n\n' +
                  'Egy id≈ëpont lemond√°sra ker√ºlt:\n\n' +
                  '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n' +
                  'üë§ N√©v: ' + data.clientName + '\n' +
                  'üìß Email: ' + data.clientEmail + '\n' +
                  'üíÜ Kezel√©s: ' + (data.service || 'Nincs megadva') + '\n' +
                  'üìÖ D√°tum: ' + data.appointmentDate + '\n' +
                  '‚è∞ Id≈ëpont: ' + data.appointmentTime + '\n' +
                  '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n';
  
  if (data.reason) {
    edinaBody += 'Indokl√°s: ' + data.reason + '\n\n';
  }
  
  edinaBody += 'Ne felejtsd el t√∂r√∂lni az id≈ëpontot a Google Napt√°rb√≥l!';
  
  MailApp.sendEmail({
    to: 'dunakeszimasszor@gmail.com',
    subject: edinaSubject,
    body: edinaBody,
    name: 'Dunakeszi Massz√°zs - Admin'
  });
  
  return createResponse(true, 'Lemond√°si √©rtes√≠t√©s elk√ºldve!');
}

function handleChange(data) {
  if (!data.clientName || !data.clientEmail || !data.appointmentDate || !data.appointmentTime || !data.newDate || !data.newTime) {
    return createResponse(false, 'Hi√°nyz√≥ k√∂telez≈ë mez≈ëk');
  }
  
  // Send change email to customer
  var subject = 'Id≈ëpont m√≥dos√≠tva - Dunakeszi Massz√°zs';
  var body = 'Kedves ' + data.clientName + '!\n\n' +
             '√ârtes√≠tj√ºk, hogy az id≈ëpontod m√≥dos√≠t√°sra ker√ºlt:\n\n' +
             '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n' +
             '‚ùå EREDETI ID≈êPONT:\n' +
             'üìÖ D√°tum: ' + data.appointmentDate + '\n' +
             '‚è∞ Id≈ëpont: ' + data.appointmentTime + '\n\n' +
             '‚úÖ √öJ ID≈êPONT:\n' +
             'üìÖ D√°tum: ' + data.newDate + '\n' +
             '‚è∞ Id≈ëpont: ' + data.newTime + '\n' +
             'üíÜ Kezel√©s: ' + (data.service || 'Nincs megadva') + '\n' +
             '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n' +
             'üìç C√çM √âS MEGK√ñZEL√çT√âS:\n' +
             'Dunakeszi, Kolonics Gy√∂rgy utca 2/B, 2120\n' +
             'Kapucseng≈ë: 1/43\n\n' +
             'Ha k√©rd√©sed van, h√≠vj b√°tran:\n' +
             'üìû +36 30 487 7883\n\n' +
             'V√°runk szeretettel az Angyali Szalonban!\n\n' +
             '√údv√∂zlettel,\n' +
             'Makra Edina\n' +
             'Dunakeszi Massz√°zs - Angyali Szalon';
  
  MailApp.sendEmail({
    to: data.clientEmail,
    subject: subject,
    body: body,
    name: 'Dunakeszi Massz√°zs - Angyali Szalon'
  });
  
  // Send notification to Edina
  var edinaSubject = 'Id≈ëpont m√≥dos√≠tva - ' + data.clientName;
  var edinaBody = 'Kedves Edina!\n\n' +
                  'Egy id≈ëpont m√≥dos√≠t√°sra ker√ºlt:\n\n' +
                  '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n' +
                  'üë§ N√©v: ' + data.clientName + '\n' +
                  'üìß Email: ' + data.clientEmail + '\n' +
                  'üíÜ Kezel√©s: ' + (data.service || 'Nincs megadva') + '\n\n' +
                  '‚ùå EREDETI:\n' +
                  'üìÖ ' + data.appointmentDate + ' ' + data.appointmentTime + '\n\n' +
                  '‚úÖ √öJ:\n' +
                  'üìÖ ' + data.newDate + ' ' + data.newTime + '\n' +
                  '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n' +
                  'Ne felejtsd el friss√≠teni az id≈ëpontot a Google Napt√°rb√≥l!';
  
  MailApp.sendEmail({
    to: 'dunakeszimasszor@gmail.com',
    subject: edinaSubject,
    body: edinaBody,
    name: 'Dunakeszi Massz√°zs - Admin'
  });
  
  return createResponse(true, 'M√≥dos√≠t√°si √©rtes√≠t√©s elk√ºldve!');
}

// ============================================
// Email Functions
// ============================================
function sendBookingConfirmationToEdina(data, recurringCount, recurringType, recurringDates, discountPercent, packageId) {
  var edinaSubject = recurringCount > 1 
    ? '√öj ism√©tl≈ëd≈ë foglal√°s - ' + data.name + ' (' + recurringCount + ' alkalom)'
    : '√öj id≈ëpontfoglal√°s - ' + data.name;
  
  var edinaBody = 'Kedves Edina!\n\n';
  
  if (recurringCount > 1) {
    edinaBody += '√öj ISM√âTL≈êD≈ê foglal√°s √©rkezett a weboldalr√≥l:\n\n';
    edinaBody += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n';
    edinaBody += 'üë§ N√âV: ' + data.name + '\n';
    edinaBody += 'üìû TELEFON: ' + (data.phone || 'Nincs megadva') + '\n';
    edinaBody += 'üìß EMAIL: ' + data.email + '\n';
    edinaBody += 'üíÜ KEZEL√âS: ' + data.service + '\n';
    edinaBody += 'üìÖ ELS≈ê D√ÅTUM: ' + data.date + '\n';
    edinaBody += '‚è∞ ID≈êPONT: ' + data.time + '\n';
    edinaBody += 'üîÑ ISM√âTL≈êD√âS: ' + getRecurringTypeText(recurringType) + '\n';
    edinaBody += 'üìä ALKALMAK SZ√ÅMA: ' + recurringCount + '\n';
    if (discountPercent > 0) {
      edinaBody += 'üí∞ KEDVEZM√âNY: ' + discountPercent + '%\n';
    }
    if (packageId) {
      edinaBody += 'üé´ B√âRLET: ' + packageId + '\n';
    }
    edinaBody += 'üìã √ñSSZES D√ÅTUM:\n';
    for (var j = 0; j < recurringDates.length; j++) {
      edinaBody += '   ' + (j + 1) + '. ' + recurringDates[j] + '\n';
    }
    edinaBody += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n';
  } else {
    edinaBody += '√öj id≈ëpontfoglal√°s √©rkezett a weboldalr√≥l:\n\n';
    edinaBody += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n';
    edinaBody += 'üë§ N√âV: ' + data.name + '\n';
    edinaBody += 'üìû TELEFON: ' + (data.phone || 'Nincs megadva') + '\n';
    edinaBody += 'üìß EMAIL: ' + data.email + '\n';
    edinaBody += 'üíÜ KEZEL√âS: ' + data.service + '\n';
    edinaBody += 'üìÖ D√ÅTUM: ' + data.date + '\n';
    edinaBody += '‚è∞ ID≈êPONT: ' + data.time + '\n';
    if (packageId) {
      edinaBody += 'üé´ B√âRLET: ' + packageId + '\n';
    }
    edinaBody += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n';
  }
  
  edinaBody += 'üìù MEGJEGYZ√âS: ' + (data.notes || 'Nincs megadva') + '\n\n';
  edinaBody += 'A foglal√°s(ok) automatikusan hozz√°adva lettek a Google Napt√°radhoz.\n\n';
  edinaBody += '√údv√∂zlettel,\n';
  edinaBody += 'Dunakeszi Massz√°zs Weboldal';
  
  MailApp.sendEmail({
    to: 'dunakeszimasszor@gmail.com',
    subject: edinaSubject,
    body: edinaBody,
    name: 'Dunakeszi Massz√°zs - Foglal√°si Rendszer'
  });
}

function sendBookingConfirmationToCustomer(data, recurringCount, recurringType, recurringDates, discountPercent, packageId, customer) {
  var customerSubject = recurringCount > 1
    ? 'Ism√©tl≈ëd≈ë id≈ëpontfoglal√°s visszaigazol√°s - Dunakeszi Massz√°zs'
    : 'Id≈ëpontfoglal√°s visszaigazol√°s - Dunakeszi Massz√°zs';
  
  var customerBody = 'Kedves ' + data.name + '!\n\n';
  customerBody += 'K√∂sz√∂nj√ºk az id≈ëpontfoglal√°sodat!\n\n';
  
  if (recurringCount > 1) {
    customerBody += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n';
    customerBody += 'üíÜ KEZEL√âS: ' + data.service + '\n';
    customerBody += 'üìÖ ELS≈ê D√ÅTUM: ' + data.date + '\n';
    customerBody += '‚è∞ ID≈êPONT: ' + data.time + '\n';
    customerBody += 'üîÑ ISM√âTL≈êD√âS: ' + getRecurringTypeText(recurringType) + '\n';
    customerBody += 'üìä ALKALMAK SZ√ÅMA: ' + recurringCount + '\n';
    if (discountPercent > 0) {
      customerBody += 'üí∞ KEDVEZM√âNY: ' + discountPercent + '%\n';
    }
    if (packageId) {
      customerBody += 'üé´ B√âRLETB≈êL FELHASZN√ÅLVA\n';
    }
    customerBody += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n';
    customerBody += 'üìã AZ √ñSSZES FOGLALT ID≈êPONT:\n';
    for (var k = 0; k < recurringDates.length; k++) {
      customerBody += '   ' + (k + 1) + '. ' + recurringDates[k] + ' ' + data.time + '\n';
    }
    customerBody += '\n';
  } else {
    customerBody += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n';
    customerBody += 'üíÜ KEZEL√âS: ' + data.service + '\n';
    customerBody += 'üìÖ D√ÅTUM: ' + data.date + '\n';
    customerBody += '‚è∞ ID≈êPONT: ' + data.time + '\n';
    if (packageId) {
      customerBody += 'üé´ B√âRLETB≈êL FELHASZN√ÅLVA\n';
    }
    customerBody += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n';
  }
  
  // Add remaining sessions info if customer has packages
  if (customer.totalSessionsRemaining > 0) {
    customerBody += 'üé´ B√âRLET EGYENLEG:\n';
    customerBody += 'H√°tral√©v≈ë alkalmak: ' + customer.totalSessionsRemaining + '\n\n';
  }
  
  customerBody += 'üìç C√çM √âS MEGK√ñZEL√çT√âS:\n';
  customerBody += 'Dunakeszi, Kolonics Gy√∂rgy utca 2/B, 2120\n';
  customerBody += 'Kapucseng≈ë: 1/43\n\n';
  customerBody += 'A kapun√°l a 1/43-as kapucseng≈ët kell megnyomni.\n\n';
  
  if (recurringCount > 1) {
    customerBody += '‚ö†Ô∏è FONTOS INFORM√ÅCI√ì ISM√âTL≈êD≈ê FOGLAL√ÅSHOZ:\n';
    customerBody += '‚Ä¢ Minden alkalom el≈ëtt 24 √≥r√°val eml√©keztet≈ët k√ºld√ºnk\n';
    customerBody += '‚Ä¢ Ha b√°rmelyik alkalomra nem tudsz elj√∂nni, k√©rj√ºk, 24 √≥r√°val el≈ëtte jelezd\n';
    customerBody += '‚Ä¢ Az id≈ëpontok m√≥dos√≠that√≥k 24 √≥ra el≈ëtt ingyenesen\n';
    if (discountPercent > 0) {
      customerBody += '‚Ä¢ Kedvezm√©ny: ' + discountPercent + '% a t√∂bb alkalmas foglal√°s√©rt\n';
    }
    customerBody += '\n';
  }
  
  customerBody += 'Ha b√°rmilyen k√©rd√©sed van, h√≠vj b√°tran:\n';
  customerBody += 'üìû +36 30 487 7883\n\n';
  customerBody += 'V√°runk szeretettel az Angyali Szalonban!\n\n';
  customerBody += '√údv√∂zlettel,\n';
  customerBody += 'Makra Edina\n';
  customerBody += 'Dunakeszi Massz√°zs - Angyali Szalon\n';
  customerBody += 'üìû +36 30 487 7883\n';
  customerBody += 'üìß dunakeszimasszor@gmail.com\n';
  customerBody += 'üåê https://dunakeszimasszazs.hu';
  
  MailApp.sendEmail({
    to: data.email,
    subject: customerSubject,
    body: customerBody,
    name: 'Dunakeszi Massz√°zs - Angyali Szalon'
  });
}

function sendPackagePurchaseConfirmation(customer, package) {
  var subject = 'B√©rlet v√°s√°rl√°s visszaigazol√°s - Dunakeszi Massz√°zs';
  
  var body = 'Kedves ' + customer.name + '!\n\n';
  body += 'K√∂sz√∂nj√ºk a b√©rlet v√°s√°rl√°sodat!\n\n';
  body += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n';
  body += 'üé´ B√âRLET R√âSZLETEI:\n';
  body += 'B√©rlet sz√°ma: ' + package.packageId + '\n';
  body += 'Alkalmak sz√°ma: ' + package.sessions + '\n';
  body += 'Eredeti √°r: ' + package.originalPrice.toLocaleString() + ' Ft\n';
  if (package.discountPercent > 0) {
    body += 'Kedvezm√©ny: ' + package.discountPercent + '% (-' + package.discountAmount.toLocaleString() + ' Ft)\n';
  }
  body += 'Fizetend≈ë: ' + package.finalPrice.toLocaleString() + ' Ft\n';
  body += 'Foglal√≥ befizetve: ' + package.depositPaid.toLocaleString() + ' Ft\n';
  body += 'H√°tral√©k: ' + (package.finalPrice - package.depositPaid).toLocaleString() + ' Ft\n';
  body += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n';
  
  body += 'Hogyan haszn√°lhatod a b√©rletet:\n';
  body += '‚Ä¢ Foglalj id≈ëpontot a weboldalon vagy telefonon\n';
  body += '‚Ä¢ A rendszer automatikusan levon egy alkalmat a b√©rletedb≈ël\n';
  body += '‚Ä¢ A h√°tral√©kot az els≈ë kezel√©sn√©l kell kifizetni\n\n';
  
  body += 'B√©rlet egyenleged: ' + (customer.totalSessionsRemaining + package.sessions) + ' alkalom\n\n';
  
  body += 'Ha k√©rd√©sed van, h√≠vj b√°tran:\n';
  body += 'üìû +36 30 487 7883\n\n';
  body += '√údv√∂zlettel,\n';
  body += 'Makra Edina\n';
  body += 'Dunakeszi Massz√°zs - Angyali Szalon';
  
  MailApp.sendEmail({
    to: customer.email,
    subject: subject,
    body: body,
    name: 'Dunakeszi Massz√°zs - Angyali Szalon'
  });
}

// ============================================
// Helper Functions
// ============================================
function createResponse(success, message, data) {
  var response = { success: success, message: message };
  if (data) { response.data = data; }
  
  var output = ContentService.createTextOutput(JSON.stringify(response));
  output.setMimeType(ContentService.MimeType.JSON);
  return output;
}

function createHtmlResponse(html) {
  var output = ContentService.createTextOutput(html);
  output.setMimeType(ContentService.MimeType.HTML);
  return output;
}

function formatDate(date) {
  return date.getFullYear() + '-' + 
         String(date.getMonth() + 1).padStart(2, '0') + '-' + 
         String(date.getDate()).padStart(2, '0');
}

function getRecurringTypeText(type) {
  switch(type) {
    case 'weekly': return 'Minden h√©ten';
    case 'biweekly': return 'K√©thetente';
    case 'monthly': return 'Minden h√≥napban';
    default: return type;
  }
}

function calculateDiscount(sessionCount) {
  if (sessionCount >= 6) return 15;
  if (sessionCount >= 4) return 10;
  if (sessionCount >= 2) return 5;
  return 0;
}

function buildEventDescription(data, sessionNum, totalSessions, packageId, sessionNumber) {
  var desc = 'Kezel√©s: ' + data.service + '\n' +
             'N√©v: ' + data.name + '\n' +
             'Telefon: ' + (data.phone || 'Nincs megadva') + '\n' +
             'Email: ' + data.email + '\n' +
             'Megjegyz√©s: ' + (data.notes || 'Nincs megadva') + '\n';
  
  if (totalSessions > 1) {
    desc += 'Alkalom: ' + sessionNum + '/' + totalSessions + '\n';
  }
  
  if (packageId) {
    desc += 'B√©rlet: ' + packageId + '\n';
    desc += 'B√©rlet alkalmak: ' + sessionNumber + '\n';
  }
  
  return desc;
}
