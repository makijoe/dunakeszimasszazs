// ============================================
// Google Apps Script for Dunakeszi Massz√°zs
// Complete Booking & Customer Management System
// With P&L Tracking and Session Package Management
// ============================================

// Sheet names
const SHEETS = {
  CUSTOMERS: 'Customers',
  SESSION_PACKAGES: 'SessionPackages',
  BOOKINGS: 'Bookings',
  FINANCIAL: 'Financial',
  PNL: 'PnL',
  LOGS: 'ErrorLogs'
};

// ============================================
// Setup - Run this once to create sheets
// ============================================
function setupSheets() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  
  // Create Customers sheet
  let customersSheet = ss.getSheetByName(SHEETS.CUSTOMERS);
  if (!customersSheet) {
    customersSheet = ss.insertSheet(SHEETS.CUSTOMERS);
    customersSheet.appendRow([
      'CustomerID', 'Name', 'Email', 'Phone', 'CreatedDate', 
      'TotalSessionsPurchased', 'TotalSessionsUsed', 'TotalSessionsRemaining',
      'TotalSpent', 'Notes'
    ]);
    customersSheet.getRange(1, 1, 1, 10).setFontWeight('bold');
  }
  
  // Create Session Packages sheet
  let packagesSheet = ss.getSheetByName(SHEETS.SESSION_PACKAGES);
  if (!packagesSheet) {
    packagesSheet = ss.insertSheet(SHEETS.SESSION_PACKAGES);
    packagesSheet.appendRow([
      'PackageID', 'CustomerID', 'CustomerName', 'PurchaseDate', 
      'ServiceType', 'SessionsPurchased', 'SessionsUsed', 'SessionsRemaining',
      'OriginalPrice', 'DiscountPercent', 'DiscountAmount', 'FinalPrice',
      'DepositPaid', 'Status', 'Notes'
    ]);
    packagesSheet.getRange(1, 1, 1, 15).setFontWeight('bold');
  }
  
  // Create Bookings sheet
  let bookingsSheet = ss.getSheetByName(SHEETS.BOOKINGS);
  if (!bookingsSheet) {
    bookingsSheet = ss.insertSheet(SHEETS.BOOKINGS);
    bookingsSheet.appendRow([
      'BookingID', 'CustomerID', 'CustomerName', 'Service', 
      'Date', 'Time', 'Status', 'PackageID', 'SessionNumber',
      'CreatedDate', 'Notes'
    ]);
    bookingsSheet.getRange(1, 1, 1, 11).setFontWeight('bold');
  }
  
  // Create Financial Transactions sheet
  let financialSheet = ss.getSheetByName(SHEETS.FINANCIAL);
  if (!financialSheet) {
    financialSheet = ss.insertSheet(SHEETS.FINANCIAL);
    financialSheet.appendRow([
      'TransactionID', 'Date', 'Type', 'CustomerID', 'CustomerName',
      'Description', 'Amount', 'PaymentMethod', 'RelatedPackageID', 'Notes'
    ]);
    financialSheet.getRange(1, 1, 1, 10).setFontWeight('bold');
  }
  
  // Create P&L Summary sheet
  let pnlSheet = ss.getSheetByName(SHEETS.PNL);
  if (!pnlSheet) {
    pnlSheet = ss.insertSheet(SHEETS.PNL);
    pnlSheet.appendRow(['Dunakeszi Massz√°zs - P&L Dashboard']);
    pnlSheet.appendRow(['']);
    pnlSheet.appendRow(['Monthly Summary']);
    pnlSheet.appendRow(['Month', 'Total Income', 'Total Deposits', 'Outstanding', 'Sessions Completed']);
    pnlSheet.getRange(3, 1, 2, 5).setFontWeight('bold');
  }
  
  return 'Sheets created successfully!';
}

// ============================================
// Main POST Handler
// ============================================
function doPost(e) {
  var lock = LockService.getScriptLock();
  try {
    lock.waitLock(30000);
    var data = {};
    
    // Google Apps Script form data is in e.parameter
    if (e && e.parameter && e.parameter.action) {
      data = e.parameter;
    } else if (e && e.postData && e.postData.contents) {
      // Try to parse as JSON
      try {
        data = JSON.parse(e.postData.contents);
      } catch (jsonError) {
        // If not JSON, parse as form data string
        var formData = e.postData.contents;
        var pairs = formData.split('&');
        for (var i = 0; i < pairs.length; i++) {
          var pair = pairs[i].split('=');
          if (pair.length === 2) {
            data[decodeURIComponent(pair[0])] = decodeURIComponent(pair[1].replace(/\+/g, ' '));
          }
        }
      }
    }
    
    // Stripe sends webhook events as JSON with a 'type' field but no 'action' field
    if (!data.action && data.type) {
      return handleStripeWebhook(data);
    }

    if (!data.action) {
      return createHtmlResponse('<h1>Hiba</h1><p>Hi√°nyz√≥ m≈±velet</p>');
    }
    
    switch(data.action) {
      case 'ping':
        return createResponse(true, 'pong');
      case 'createBooking':
        return createBooking(data);
      case 'purchasePackage':
        return purchasePackage(data);
      case 'useSession':
        return useSession(data);
      case 'getCustomerProfile':
        return getCustomerProfile(data);
      case 'getAllCustomers':
        return getAllCustomers();
      case 'getPnL':
        return getPnL(data);
      case 'cancel':
        return handleCancellation(data);
      case 'change':
        return handleChange(data);
      case 'selfCancel':
        return selfCancelBooking_(data);
      case 'selfChange':
        return selfRequestChange_(data);
      case 'createStripeCheckout':
        return createStripeCheckout(data);
      case 'createStripeCheckoutDebug':
        return createStripeCheckoutDebug(data);
      default:
        return createHtmlResponse('<h1>Hiba</h1><p>Ismeretlen m≈±velet: ' + data.action + '</p>');
    }
  } catch (error) {
    logError('doPost', error);
    return createHtmlResponse('<h1>Hiba</h1><p>' + error.message + '</p>');
  } finally {
    lock.releaseLock();
  }
}

// ============================================
// GET Handler for Dashboard Data
// ============================================
function doGet(e) {
  try {
    var action = e.parameter.action;
    
    switch(action) {
      case 'dashboard':
        return getDashboardData();
      case 'customer':
        return getCustomerProfile({ email: e.parameter.email });
      case 'pnl':
        return getPnL({ mode: e.parameter.mode, month: e.parameter.month, year: e.parameter.year, date: e.parameter.date, weekStart: e.parameter.weekStart });
      case 'allBookings':
        return getAllBookings_();
      case 'pendingBookings':
        return getPendingBookings_();
      case 'allPackages':
        return getAllPackages_();
      case 'myBookings':
        return getMyBookings_(e.parameter.email);
      default:
        return createResponse(true, 'API is running', { 
          endpoints: ['dashboard', 'customer', 'pnl'] 
        });
    }
  } catch (error) {
    return createResponse(false, 'Hiba: ' + error.message);
  }
}

// ============================================
// Create New Booking with Session Tracking
// ============================================
function createBooking(data) {
  // Validate required fields
  if (!data.name || !data.email || !data.service || !data.date || !data.time) {
    return createResponse(false, 'Hi√°nyz√≥ k√∂telez≈ë mez≈ëk');
  }
  
  var customer = getOrCreateCustomer(data.name, data.email, data.phone);
  var customerId = customer.customerId;

  // Prevent same customer from double-booking the same date + time
  // 1) Check in-memory cache first (GAS read cache means sheet reads are stale in same execution)
  if (_createdBookingKeys[customerId + '|' + data.date + '|' + data.time]) {
    return createResponse(false, 'Ezen az id≈ëponton m√°r van akt√≠v foglal√°sod! K√©rj√ºk v√°lassz m√°sik id≈ëpontot.');
  }
  // 2) Check persisted sheet data (catches cross-execution duplicates)
  var dupSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEETS.BOOKINGS);
  var dupData = dupSheet.getDataRange().getValues();
  for (var di = 1; di < dupData.length; di++) {
    if (dupData[di][1] === customerId && (dupData[di][6] === 'Confirmed' || dupData[di][6] === 'ChangeRequested')) {
      var dupDate = typeof dupData[di][4] === 'string' ? dupData[di][4].slice(0,10) : formatDate(new Date(dupData[di][4]));
      var dupTime = formatTimeFromSheet(dupData[di][5]);
      if (dupDate === data.date && dupTime === data.time) {
        return createResponse(false, 'Ezen az id≈ëponton m√°r van akt√≠v foglal√°sod! K√©rj√ºk v√°lassz m√°sik id≈ëpontot.');
      }
    }
  }

  // Check if customer has active session package
  var activePackage = findActivePackage(customerId, data.service);

  var packageId = null;
  var sessionNumber = null;

  // Handle recurring booking ‚Üí auto-create a b√©rlet (SessionPackages entry)
  var recurringCountEarly = (data.recurring === true || data.recurring === 'yes' || data.recurring === 'true') ? (parseInt(data.recurringCount) || 1) : 1;

  if (recurringCountEarly >= 2) {
    // Auto-create a b√©rlet for this multi-session booking
    var ss2 = SpreadsheetApp.getActiveSpreadsheet();
    var packagesSheet2 = ss2.getSheetByName(SHEETS.SESSION_PACKAGES);
    var autoPackageId = 'PKG' + Date.now();
    var pricePerSession = 15000; // all services are 15 000 Ft
    var autoOriginalPrice = recurringCountEarly * pricePerSession;
    var autoDiscountPct = calculateDiscount(recurringCountEarly);
    var autoDiscountAmt = Math.round(autoOriginalPrice * (autoDiscountPct / 100));
    var autoFinalPrice = autoOriginalPrice - autoDiscountAmt;
    // deposit already paid by customer via Stripe (passed in as data.amount in Ft)
    var autoDepositPaid = parseInt(data.amount) || Math.round(autoFinalPrice * 0.2);
    packagesSheet2.appendRow([
      autoPackageId,
      customerId,
      data.name,
      formatDate(new Date()),
      data.service || 'B√°rmely kezel√©s',
      recurringCountEarly,   // sessionsPurchased
      0,                     // sessionsUsed (none completed yet)
      recurringCountEarly,   // sessionsRemaining
      autoOriginalPrice,
      autoDiscountPct,
      autoDiscountAmt,
      autoFinalPrice,
      autoDepositPaid,
      'Active',
      'Automatikusan l√©trehozva ‚Äì ism√©tl≈ëd≈ë foglal√°sb√≥l (' + recurringCountEarly + ' alkalom)'
    ]);
    SpreadsheetApp.flush();
    updateCustomerSessionTotals(customerId);
    packageId = autoPackageId;
  } else if ((data.usePackage === true || data.usePackage === 'true') && activePackage) {
    // Single-session booking deducting from an existing package
    var useResult = deductSessionFromPackage(activePackage.packageId);
    if (useResult.success) {
      packageId = activePackage.packageId;
      sessionNumber = useResult.sessionNumber;
    }
  }

  // Create calendar event
  var calendar = CalendarApp.getDefaultCalendar();
  var dateParts = data.date.split('-');
  var timeParts = data.time.split(':');
  var startTime = new Date(
    parseInt(dateParts[0]), parseInt(dateParts[1]) - 1, parseInt(dateParts[2]),
    parseInt(timeParts[0]), parseInt(timeParts[1])
  );
  var endTime = new Date(startTime.getTime() + (75 * 60 * 1000));
  
  // Handle recurring bookings
  var recurringCount = (data.recurring === true || data.recurring === 'yes' || data.recurring === 'true') ? (parseInt(data.recurringCount) || 1) : 1;
  var recurringType = data.recurringType || 'weekly';
  var createdEvents = [];
  var createdBookingIds = [];
  var recurringDates = [];
  
  var discountPercent = calculateDiscount(recurringCount);
  
  for (var i = 0; i < recurringCount; i++) {
    var occurrenceStart = new Date(startTime);
    var occurrenceEnd = new Date(endTime);
    
    if (i > 0) {
      if (recurringType === 'weekly') {
        occurrenceStart.setDate(occurrenceStart.getDate() + (i * 7));
        occurrenceEnd.setDate(occurrenceEnd.getDate() + (i * 7));
      } else if (recurringType === 'biweekly') {
        occurrenceStart.setDate(occurrenceStart.getDate() + (i * 14));
        occurrenceEnd.setDate(occurrenceEnd.getDate() + (i * 14));
      } else if (recurringType === 'monthly') {
        occurrenceStart.setMonth(occurrenceStart.getMonth() + i);
        occurrenceEnd.setMonth(occurrenceEnd.getMonth() + i);
      }
    }
    
    var dateStr = formatDate(occurrenceStart);
    recurringDates.push(dateStr);
    
    // Create calendar event
    var eventTitle = 'Massz√°zs - ' + data.name + ' - ' + data.service;
    if (recurringCount > 1) eventTitle += ' (' + (i + 1) + '/' + recurringCount + ')';
    if (packageId) eventTitle += ' [B√©rlet]';
    
    var event = calendar.createEvent(eventTitle, occurrenceStart, occurrenceEnd, {
      description: buildEventDescription(data, i + 1, recurringCount, packageId, sessionNumber),
      location: 'Angyali Szalon, Dunakeszi'
    });
    event.setColor(packageId ? '2' : '6'); // Green for package sessions, orange for regular
    var eventId = event.getId();
    createdEvents.push(eventId);
    
    // Record booking (including calendar event ID and Stripe payment intent for refunds)
    var newBookingId = recordBooking(customerId, data.name, data.service, dateStr, data.time, packageId, sessionNumber, eventId, data.stripePaymentIntentId || '');
    createdBookingIds.push(newBookingId);
    // Register in-memory so same-execution duplicate checks catch this immediately
    _createdBookingKeys[customerId + '|' + dateStr + '|' + data.time] = true;
  }
  
  // Send confirmation emails
  sendBookingConfirmationToEdina(data, recurringCount, recurringType, recurringDates, discountPercent, packageId);
  sendBookingConfirmationToCustomer(data, recurringCount, recurringType, recurringDates, discountPercent, packageId, customer);
  
  return createResponse(true, 'Foglal√°s sikeresen r√∂gz√≠tve!', {
    customerId: customerId,
    eventIds: createdEvents,
    bookingIds: createdBookingIds,
    recurringCount: recurringCount,
    recurringDates: recurringDates,
    discountPercent: discountPercent,
    packageUsed: packageId !== null,
    customerProfile: customer
  });
}

// ============================================
// Purchase Session Package
// ============================================
function purchasePackage(data) {
  if (!data.customerId && !data.email) {
    return createResponse(false, 'CustomerID vagy email sz√ºks√©ges');
  }
  
  var customer;
  if (data.customerId) {
    customer = getCustomerById(data.customerId);
  } else {
    customer = getOrCreateCustomer(data.name, data.email, data.phone);
  }
  
  if (!customer) {
    return createResponse(false, 'V√°s√°rl√≥ nem tal√°lhat√≥');
  }
  
  var packageId = 'PKG' + Date.now();
  var purchaseDate = new Date();
  
  var sessionsPurchased = data.sessions || 12;
  var originalPrice = data.originalPrice || (sessionsPurchased * 15000);
  var discountPercent = calculateDiscount(sessionsPurchased);
  var discountAmount = Math.round(originalPrice * (discountPercent / 100));
  var finalPrice = originalPrice - discountAmount;
  var depositPaid = data.depositPaid || Math.round(finalPrice * 0.2);
  
  // Record package
  var packagesSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEETS.SESSION_PACKAGES);
  packagesSheet.appendRow([
    packageId,
    customer.customerId,
    customer.name,
    formatDate(purchaseDate),
    data.service || 'B√°rmely kezel√©s',
    sessionsPurchased,
    0, // sessions used
    sessionsPurchased, // sessions remaining
    originalPrice,
    discountPercent,
    discountAmount,
    finalPrice,
    depositPaid,
    'Active',
    data.notes || ''
  ]);
  
  // Record financial transaction
  recordTransaction(purchaseDate, 'Deposit', customer.customerId, customer.name, 
    'B√©rlet foglal√≥ (' + sessionsPurchased + ' alkalom)', depositPaid, 'Bank Transfer', packageId);
  
  // Update customer totals
  updateCustomerSessionTotals(customer.customerId);
  
  // Send confirmation email
  sendPackagePurchaseConfirmation(customer, {
    packageId: packageId,
    sessions: sessionsPurchased,
    originalPrice: originalPrice,
    discountPercent: discountPercent,
    discountAmount: discountAmount,
    finalPrice: finalPrice,
    depositPaid: depositPaid
  });
  
  return createResponse(true, 'B√©rlet sikeresen l√©trehozva!', {
    packageId: packageId,
    customerId: customer.customerId,
    sessionsPurchased: sessionsPurchased,
    finalPrice: finalPrice,
    depositPaid: depositPaid
  });
}

// ============================================
// Use/Deduct Session from Package
// ============================================
function useSession(data) {
  if (!data.packageId && !data.customerId) {
    return createResponse(false, 'PackageID vagy CustomerID sz√ºks√©ges');
  }
  
  var pkg;
  if (data.packageId) {
    pkg = getPackageById(data.packageId);
  } else {
    pkg = findActivePackage(data.customerId, data.service);
  }
  
  if (!pkg || pkg.sessionsRemaining <= 0) {
    return createResponse(false, 'Nincs akt√≠v b√©rlet vagy elfogytak az alkalmak');
  }
  
  return deductSessionFromPackage(pkg.packageId);
}

function deductSessionFromPackage(packageId) {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var packagesSheet = ss.getSheetByName(SHEETS.SESSION_PACKAGES);
  var data = packagesSheet.getDataRange().getValues();
  
  for (var i = 1; i < data.length; i++) {
    if (data[i][0] === packageId) {
      var sessionsUsed = data[i][6] + 1;
      var sessionsRemaining = data[i][5] - sessionsUsed;
      
      packagesSheet.getRange(i + 1, 7).setValue(sessionsUsed);
      packagesSheet.getRange(i + 1, 8).setValue(sessionsRemaining);
      
      if (sessionsRemaining <= 0) {
        packagesSheet.getRange(i + 1, 14).setValue('Completed');
      }
      
      // Update customer totals
      updateCustomerSessionTotals(data[i][1]);
      
      return {
        success: true,
        packageId: packageId,
        sessionNumber: sessionsUsed,
        sessionsRemaining: sessionsRemaining
      };
    }
  }
  
  return { success: false, message: 'B√©rlet nem tal√°lhat√≥' };
}

// ============================================
// Customer Management
// ============================================
function getOrCreateCustomer(name, email, phone) {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var customersSheet = ss.getSheetByName(SHEETS.CUSTOMERS);
  var data = customersSheet.getDataRange().getValues();
  
  // Search by email
  for (var i = 1; i < data.length; i++) {
    if (data[i][2] === email) {
      return {
        customerId: data[i][0],
        name: data[i][1],
        email: data[i][2],
        phone: data[i][3],
        createdDate: data[i][4],
        totalSessionsPurchased: data[i][5],
        totalSessionsUsed: data[i][6],
        totalSessionsRemaining: data[i][7],
        totalSpent: data[i][8],
        notes: data[i][9],
        isNew: false
      };
    }
  }
  
  // Create new customer
  var customerId = 'CUST' + Date.now();
  var createdDate = new Date();
  
  customersSheet.appendRow([
    customerId,
    name,
    email,
    phone || '',
    formatDate(createdDate),
    0, 0, 0, 0, ''
  ]);
  
  return {
    customerId: customerId,
    name: name,
    email: email,
    phone: phone || '',
    createdDate: formatDate(createdDate),
    totalSessionsPurchased: 0,
    totalSessionsUsed: 0,
    totalSessionsRemaining: 0,
    totalSpent: 0,
    notes: '',
    isNew: true
  };
}

function getCustomerById(customerId) {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var customersSheet = ss.getSheetByName(SHEETS.CUSTOMERS);
  var data = customersSheet.getDataRange().getValues();
  
  for (var i = 1; i < data.length; i++) {
    if (data[i][0] === customerId) {
      return {
        customerId: data[i][0],
        name: data[i][1],
        email: data[i][2],
        phone: data[i][3],
        createdDate: data[i][4],
        totalSessionsPurchased: data[i][5],
        totalSessionsUsed: data[i][6],
        totalSessionsRemaining: data[i][7],
        totalSpent: data[i][8],
        notes: data[i][9]
      };
    }
  }
  return null;
}

function getCustomerProfile(data) {
  if (!data.email && !data.customerId) {
    return createResponse(false, 'Email vagy CustomerID sz√ºks√©ges');
  }
  
  var customer;
  if (data.customerId) {
    customer = getCustomerById(data.customerId);
  } else {
    var result = getOrCreateCustomer(data.name || '', data.email, data.phone || '');
    customer = result;
  }
  
  if (!customer) {
    return createResponse(false, 'V√°s√°rl√≥ nem tal√°lhat√≥');
  }
  
  // Get active packages
  var packages = getCustomerPackages(customer.customerId);
  
  // Get booking history
  var bookings = getCustomerBookings(customer.customerId);
  
  return createResponse(true, 'Profil bet√∂ltve', {
    customer: customer,
    activePackages: packages.filter(p => p.status === 'Active'),
    completedPackages: packages.filter(p => p.status === 'Completed'),
    recentBookings: bookings.slice(0, 10),
    allBookings: bookings
  });
}

function getAllCustomers() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var customersSheet = ss.getSheetByName(SHEETS.CUSTOMERS);
  var data = customersSheet.getDataRange().getValues();
  
  var customers = [];
  for (var i = 1; i < data.length; i++) {
    customers.push({
      customerId: data[i][0],
      name: data[i][1],
      email: data[i][2],
      phone: data[i][3],
      totalSessionsRemaining: data[i][7],
      totalSpent: data[i][8]
    });
  }
  
  return createResponse(true, 'V√°s√°rl√≥k list√°ja', { customers: customers });
}

function getCustomerPackages(customerId) {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var packagesSheet = ss.getSheetByName(SHEETS.SESSION_PACKAGES);
  var data = packagesSheet.getDataRange().getValues();
  
  var packages = [];
  for (var i = 1; i < data.length; i++) {
    if (data[i][1] === customerId) {
      packages.push({
        packageId: data[i][0],
        purchaseDate: data[i][3],
        serviceType: data[i][4],
        sessionsPurchased: data[i][5],
        sessionsUsed: data[i][6],
        sessionsRemaining: data[i][7],
        originalPrice: data[i][8],
        discountPercent: data[i][9],
        discountAmount: data[i][10],
        finalPrice: data[i][11],
        depositPaid: data[i][12],
        status: data[i][13]
      });
    }
  }
  return packages;
}

function getCustomerBookings(customerId) {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var bookingsSheet = ss.getSheetByName(SHEETS.BOOKINGS);
  var data = bookingsSheet.getDataRange().getValues();
  
  var bookings = [];
  for (var i = 1; i < data.length; i++) {
    if (data[i][1] === customerId) {
      bookings.push({
        bookingId: data[i][0],
        service: data[i][3],
        date: data[i][4],
        time: data[i][5],
        status: data[i][6],
        packageId: data[i][7],
        sessionNumber: data[i][8]
      });
    }
  }
  return bookings.reverse(); // Most recent first
}

function findActivePackage(customerId, serviceType) {
  var packages = getCustomerPackages(customerId);
  
  for (var i = 0; i < packages.length; i++) {
    if (packages[i].status === 'Active' && packages[i].sessionsRemaining > 0) {
      // Check if service matches or package is for any service
      if (packages[i].serviceType === 'B√°rmely kezel√©s' || 
          packages[i].serviceType === serviceType ||
          !serviceType) {
        return packages[i];
      }
    }
  }
  return null;
}

function getPackageById(packageId) {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var packagesSheet = ss.getSheetByName(SHEETS.SESSION_PACKAGES);
  var data = packagesSheet.getDataRange().getValues();
  
  for (var i = 1; i < data.length; i++) {
    if (data[i][0] === packageId) {
      return {
        packageId: data[i][0],
        customerId: data[i][1],
        sessionsPurchased: data[i][5],
        sessionsUsed: data[i][6],
        sessionsRemaining: data[i][7],
        status: data[i][13]
      };
    }
  }
  return null;
}

function updateCustomerSessionTotals(customerId) {
  var packages = getCustomerPackages(customerId);
  
  var totalPurchased = 0;
  var totalUsed = 0;
  var totalSpent = 0;
  
  for (var i = 0; i < packages.length; i++) {
    totalPurchased += packages[i].sessionsPurchased;
    totalUsed += packages[i].sessionsUsed;
    totalSpent += packages[i].finalPrice;
  }
  
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var customersSheet = ss.getSheetByName(SHEETS.CUSTOMERS);
  var data = customersSheet.getDataRange().getValues();
  
  for (var j = 1; j < data.length; j++) {
    if (data[j][0] === customerId) {
      customersSheet.getRange(j + 1, 6).setValue(totalPurchased);
      customersSheet.getRange(j + 1, 7).setValue(totalUsed);
      customersSheet.getRange(j + 1, 8).setValue(totalPurchased - totalUsed);
      customersSheet.getRange(j + 1, 9).setValue(totalSpent);
      break;
    }
  }
}

// ============================================
// Stripe Checkout Integration
// ============================================

// Stripe keys are read from Script Properties for security.
// Set these in Apps Script: Project Settings ‚Üí Script properties
const STRIPE_SECRET_KEY = PropertiesService.getScriptProperties().getProperty('STRIPE_SECRET_KEY') || '';
const STRIPE_PUBLISHABLE_KEY = PropertiesService.getScriptProperties().getProperty('STRIPE_PUBLISHABLE_KEY') || '';
const STRIPE_WEBHOOK_SECRET = PropertiesService.getScriptProperties().getProperty('STRIPE_WEBHOOK_SECRET') || '';

function createStripeCheckout(data) {
  try {
    // Validate required fields
    if (!data.name || !data.email) {
      return createHtmlResponse('<h1>Hiba</h1><p>Hi√°nyz√≥ k√∂telez≈ë mez≈ëk (n√©v, email)</p>');
    }
    
    // Parse and validate amount
    var amount = parseInt(data.amount);
    
    // Safety check: Stripe minimum for HUF is 175 Ft.
    // Force minimum 3000 Ft (20% of cheapest service 15000 Ft)
    if (!amount || isNaN(amount) || amount < 175) {
      amount = 3000;
      Logger.log('Backend safety check triggered. Received: ' + data.amount + ', using: 3000 Ft');
    }
    
    // Additional safety: ensure minimum 3000 Ft
    if (amount < 3000) {
      amount = 3000;
      Logger.log('Amount was below 3000, forcing to 3000 Ft');
    }
    
    Logger.log('Creating Stripe checkout with amount: ' + amount + ' Ft');

    // Check if the requested time slot is still available before charging the customer
    if (data.date && data.time && !isTimeSlotAvailable(data.date, data.time)) {
      return createResponse(false, 'Ez az id≈ëpont sajnos m√°r foglalt. K√©rj√ºk v√°lasszon m√°sik id≈ëpontot!');
    }
    
    var serviceName = data.service || 'Massz√°zs kezel√©s';
    var recurringText = data.recurring === 'yes' ? ' (' + data.recurringCount + ' alkalom)' : '';
    
    // Build form-encoded payload for Stripe API
    // Stripe requires application/x-www-form-urlencoded format
    // NOTE: HUF is a two-decimal currency in Stripe. Amounts must be in fill√©r (1/100 Forint).
    // Multiply Forint amount by 100. E.g. 3000 Ft ‚Üí 300000 fill√©r.
    var payload = 
      'mode=payment' +
      '&line_items[0][price_data][currency]=huf' +
      '&line_items[0][price_data][product_data][name]=' + encodeURIComponent('Foglal√°si d√≠j - ' + serviceName + recurringText) +
      '&line_items[0][price_data][product_data][description]=' + encodeURIComponent('Dunakeszi Massz√°zs - Angyali Szalon foglal√°si d√≠j') +
      '&line_items[0][price_data][unit_amount]=' + (amount * 100) + // HUF is two-decimal: send fill√©r (Ft √ó 100)
      '&line_items[0][quantity]=1' +
      '&customer_email=' + encodeURIComponent(data.email) +
      '&success_url=' + encodeURIComponent(data.successUrl || 'https://dunakeszimasszazs.hu/#booking-success') +
      '&cancel_url=' + encodeURIComponent(data.cancelUrl || 'https://dunakeszimasszazs.hu/#booking-cancel') +
      '&metadata[customer_name]=' + encodeURIComponent(data.name) +
      '&metadata[customer_email]=' + encodeURIComponent(data.email) +
      '&metadata[service]=' + encodeURIComponent(data.service || '') +
      '&metadata[date]=' + encodeURIComponent(data.date || '') +
      '&metadata[time]=' + encodeURIComponent(data.time || '') +
      '&metadata[recurring]=' + encodeURIComponent(data.recurring || 'no') +
      '&metadata[recurring_count]=' + encodeURIComponent(data.recurringCount || '1');
    
    var options = {
      method: 'POST',
      headers: {
        'Authorization': 'Bearer ' + STRIPE_SECRET_KEY,
        'Content-Type': 'application/x-www-form-urlencoded'
      },
      payload: payload,
      muteHttpExceptions: true // This allows us to see the full error response
    };
    
    var response = UrlFetchApp.fetch('https://api.stripe.com/v1/checkout/sessions', options);
    var responseCode = response.getResponseCode();
    var result = JSON.parse(response.getContentText());
    
    if (responseCode === 200 && result.url) {
      // Store pending booking data
      storePendingBooking(data);
      
      // Return JSON with the URL instead of HTML
      // This is more reliable for AJAX/Fetch calls from the website
      return createResponse(true, 'Booking recorded, redirect to Stripe', { url: result.url });
    } else {
      // Log the full error for debugging
      Logger.log('Stripe error: ' + JSON.stringify(result));
      return createResponse(false, 'Hiba a Stripe checkout l√©trehoz√°sakor: ' + (result.error ? result.error.message : 'Ismeretlen hiba (HTTP ' + responseCode + ')'));
    }
    
  } catch (error) {
    logError('createStripeCheckout', error);
    return createResponse(false, 'Hiba a Stripe checkout sor√°n: ' + error.message);
  }
}

/**
 * Debug helper: creates a Stripe Checkout session and returns the raw Stripe response as JSON.
 * Use this for testing via curl/postman. Does not store pending booking or redirect.
 */
function createStripeCheckoutDebug(data) {
  try {
    if (!data.email) {
      return createResponse(false, 'Missing required fields: email');
    }

    var amount = parseInt(data.amount);
    
    // Safety check: Stripe minimum for HUF is 175 Ft.
    // Force minimum 3000 Ft (20% of cheapest service 15000 Ft)
    if (!amount || isNaN(amount) || amount < 175) {
      amount = 3000;
      Logger.log('Debug backend safety check. Received: ' + data.amount + ', using: 3000 Ft');
    }
    
    // Additional safety: ensure minimum 3000 Ft
    if (amount < 3000) {
      amount = 3000;
    }
    
    var serviceName = data.service || 'Massz√°zs kezel√©s';
    var recurringText = data.recurring === 'yes' ? ' (' + data.recurringCount + ' alkalom)' : '';

    // NOTE: HUF is a two-decimal currency in Stripe. Amounts must be in fill√©r (1/100 Forint).
    var payload = 
      'mode=payment' +
      '&line_items[0][price_data][currency]=huf' +
      '&line_items[0][price_data][product_data][name]=' + encodeURIComponent('Foglal√°si d√≠j - ' + serviceName + recurringText) +
      '&line_items[0][price_data][product_data][description]=' + encodeURIComponent('Dunakeszi Massz√°zs - Angyali Szalon foglal√°si d√≠j') +
      '&line_items[0][price_data][unit_amount]=' + (amount * 100) + // HUF is two-decimal: send fill√©r (Ft √ó 100)
      '&line_items[0][quantity]=1' +
      '&customer_email=' + encodeURIComponent(data.email) +
      '&success_url=' + encodeURIComponent(data.successUrl || 'https://dunakeszimasszazs.hu/#booking-success') +
      '&cancel_url=' + encodeURIComponent(data.cancelUrl || 'https://dunakeszimasszazs.hu/#booking-cancel') +
      '&metadata[customer_name]=' + encodeURIComponent(data.name || '') +
      '&metadata[customer_email]=' + encodeURIComponent(data.email || '') +
      '&metadata[service]=' + encodeURIComponent(data.service || '') +
      '&metadata[date]=' + encodeURIComponent(data.date || '') +
      '&metadata[time]=' + encodeURIComponent(data.time || '') +
      '&metadata[recurring]=' + encodeURIComponent(data.recurring || 'no') +
      '&metadata[recurring_count]=' + encodeURIComponent(data.recurringCount || '1');

    var options = {
      method: 'POST',
      headers: {
        'Authorization': 'Bearer ' + STRIPE_SECRET_KEY,
        'Content-Type': 'application/x-www-form-urlencoded'
      },
      payload: payload,
      muteHttpExceptions: true
    };

    var response = UrlFetchApp.fetch('https://api.stripe.com/v1/checkout/sessions', options);
    var responseCode = response.getResponseCode();
    var resultText = response.getContentText();
    var result = {};
    try { result = JSON.parse(resultText); } catch (e) { result = { raw: resultText }; }

    return createResponse(true, 'Stripe API response', { status: responseCode, body: result });
  } catch (err) {
    return createResponse(false, 'Debug error: ' + err.message);
  }
}

/**
 * Convenience helper to set Stripe keys into Script Properties from the editor.
 * Run this in the Apps Script editor after replacing the placeholder values with your keys.
 */
function setStripeProperties() {
  var props = PropertiesService.getScriptProperties();
  props.setProperties({
    STRIPE_SECRET_KEY: 'sk_test_REPLACE_WITH_YOURS',
    STRIPE_PUBLISHABLE_KEY: 'pk_test_REPLACE_WITH_YOURS',
    STRIPE_WEBHOOK_SECRET: 'whsec_REPLACE_WITH_YOURS'
  });
  Logger.log('Stripe script properties set (replace placeholders with real keys if needed).');
}

function storePendingBooking(data) {
  // Store booking data temporarily until payment is confirmed
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var pendingSheet = ss.getSheetByName('PendingBookings');
  
  if (!pendingSheet) {
    pendingSheet = ss.insertSheet('PendingBookings');
    pendingSheet.appendRow([
      'Timestamp', 'Name', 'Email', 'Phone', 'Service', 'Date', 'Time', 
      'Notes', 'Recurring', 'RecurringType', 'RecurringCount', 'Amount', 'Status'
    ]);
    pendingSheet.getRange(1, 1, 1, 13).setFontWeight('bold');
  }
  
  pendingSheet.appendRow([
    new Date(),
    data.name,
    data.email,
    data.phone || '',
    data.service,
    data.date,
    data.time,
    data.notes || '',
    (data.recurring === true || data.recurring === 'yes' || data.recurring === 'true') ? 'yes' : 'no',
    data.recurringType || '',
    data.recurringCount || 1,
    data.amount,
    'pending'
  ]);
}

// ============================================
// Get All Bookings & Pending Bookings (for Admin Panel)
// ============================================
function getAllBookings_() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var bookingsSheet = ss.getSheetByName(SHEETS.BOOKINGS);
  var data = bookingsSheet.getDataRange().getValues();

  // Build customerId -> email lookup map
  var customersSheet = ss.getSheetByName(SHEETS.CUSTOMERS);
  var custData = customersSheet.getDataRange().getValues();
  var emailMap = {};
  for (var k = 1; k < custData.length; k++) {
    emailMap[custData[k][0]] = custData[k][2];
  }

  var bookings = [];
  for (var i = 1; i < data.length; i++) {
    bookings.push({
      bookingId: data[i][0],
      customerId: data[i][1],
      customerName: data[i][2],
      customerEmail: emailMap[data[i][1]] || '',
      service: data[i][3],
      date: typeof data[i][4] === 'string' ? data[i][4].slice(0,10) : formatDate(new Date(data[i][4])),
      time: formatTimeFromSheet(data[i][5]),
      status: data[i][6],
      packageId: data[i][7],
      sessionNumber: data[i][8],
      createdDate: typeof data[i][9] === 'string' ? data[i][9].slice(0,10) : (data[i][9] ? formatDate(new Date(data[i][9])) : '')
    });
  }
  return createResponse(true, '√ñsszes fogl√°l√°s', { bookings: bookings.reverse() });
}

function getPendingBookings_() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var pendingSheet = ss.getSheetByName('PendingBookings');
  if (!pendingSheet) return createResponse(true, 'Nincs f√ºgg≈ë fogl√°l√°s', { bookings: [] });
  var data = pendingSheet.getDataRange().getValues();
  var bookings = [];
  for (var i = 1; i < data.length; i++) {
    bookings.push({
      timestamp: data[i][0],
      name: data[i][1],
      email: data[i][2],
      phone: data[i][3],
      service: data[i][4],
      date: data[i][5],
      time: data[i][6],
      notes: data[i][7],
      recurring: data[i][8],
      recurringCount: data[i][10],
      amount: data[i][11],
      status: data[i][12]
    });
  }
  return createResponse(true, 'F√ºgg≈ë fogl√°l√°sok', { bookings: bookings.reverse() });
}

// ============================================
// Record Booking
// ============================================
function recordBooking(customerId, customerName, service, date, time, packageId, sessionNumber, calendarEventId, stripePaymentIntentId) {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var bookingsSheet = ss.getSheetByName(SHEETS.BOOKINGS);
  
  var bookingId = 'BK' + Date.now() + Math.random().toString(36).substr(2, 5);
  
  bookingsSheet.appendRow([
    bookingId,
    customerId,
    customerName,
    service,
    date,
    time,
    'Confirmed',
    packageId || '',
    sessionNumber || '',
    formatDate(new Date()),
    calendarEventId || '',
    stripePaymentIntentId || ''
  ]);
  SpreadsheetApp.flush(); // Ensure row is immediately visible to subsequent reads in the same execution
  
  return bookingId;
}

// ============================================
// Financial Tracking
// ============================================
function recordTransaction(date, type, customerId, customerName, description, amount, paymentMethod, relatedId) {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var financialSheet = ss.getSheetByName(SHEETS.FINANCIAL);
  
  var transactionId = 'TXN' + Date.now();
  
  financialSheet.appendRow([
    transactionId,
    formatDate(date),
    type,
    customerId || '',
    customerName || '',
    description,
    amount,
    paymentMethod || '',
    relatedId || '',
    ''
  ]);
  
  return transactionId;
}

// ============================================
// Get All Packages
// ============================================
function getAllPackages_() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var packagesSheet = ss.getSheetByName(SHEETS.SESSION_PACKAGES);
  if (!packagesSheet) return createResponse(false, 'SessionPackages lap nem tal√°lhat√≥');
  var data = packagesSheet.getDataRange().getValues();
  var packages = [];
  for (var i = 1; i < data.length; i++) {
    if (!data[i][0]) continue; // skip empty rows
    packages.push({
      packageId: data[i][0],
      customerId: data[i][1],
      customerName: data[i][2],
      purchaseDate: data[i][3],
      serviceType: data[i][4],
      sessionsPurchased: data[i][5],
      sessionsUsed: data[i][6],
      sessionsRemaining: data[i][7],
      originalPrice: data[i][8],
      discountPercent: data[i][9],
      discountAmount: data[i][10],
      finalPrice: data[i][11],
      depositPaid: data[i][12],
      status: data[i][13],
      notes: data[i][14] || ''
    });
  }
  packages.reverse();
  return createResponse(true, 'B√©rletek list√°ja', { packages: packages });
}

// ============================================
// Self-Service Booking Management
// ============================================
// Customers can view, cancel, or request changes to their own bookings

function getMyBookings_(email) {
  if (!email) return createResponse(false, 'Email c√≠m sz√ºks√©ges');

  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var customersSheet = ss.getSheetByName(SHEETS.CUSTOMERS);
  var customerData = customersSheet.getDataRange().getValues();

  var customerId = null;
  var customerName = '';
  for (var i = 1; i < customerData.length; i++) {
    if (customerData[i][2] === email) {
      customerId = customerData[i][0];
      customerName = customerData[i][1];
      break;
    }
  }

  if (!customerId) {
    return createResponse(false, 'Nem tal√°ltunk foglal√°st ezzel az email-lel. Ellen≈ërizd a foglal√°skor haszn√°lt c√≠met.');
  }

  var bookingsSheet = ss.getSheetByName(SHEETS.BOOKINGS);
  var bookingsData = bookingsSheet.getDataRange().getValues();
  var today = new Date();
  today.setHours(0, 0, 0, 0);

  var bookings = [];
  for (var j = 1; j < bookingsData.length; j++) {
    if (bookingsData[j][1] === customerId && (bookingsData[j][6] === 'Confirmed' || bookingsData[j][6] === 'ChangeRequested')) {
      var bookingDate = new Date(bookingsData[j][4]);
      if (bookingDate >= today) {
        bookings.push({
          bookingId: bookingsData[j][0],
          service: bookingsData[j][3],
          date: typeof bookingsData[j][4] === 'string' ? bookingsData[j][4].slice(0,10) : formatDate(new Date(bookingsData[j][4])),
          time: formatTimeFromSheet(bookingsData[j][5]),
          status: bookingsData[j][6],
          calendarEventId: bookingsData[j][10] || ''
        });
      }
    }
  }

  bookings.sort(function(a, b) { return new Date(a.date) - new Date(b.date); });

  return createResponse(true, 'Foglal√°sok bet√∂ltve', {
    bookings: bookings,
    customerName: customerName
  });
}

function selfCancelBooking_(data) {
  var bookingId = data.bookingId;
  var email = data.email;
  var reason = data.reason || '';

  if (!bookingId || !email) return createResponse(false, 'Hi√°nyz√≥ adatok');

  var ss = SpreadsheetApp.getActiveSpreadsheet();

  // Find customer by email
  var customersSheet = ss.getSheetByName(SHEETS.CUSTOMERS);
  var customerData = customersSheet.getDataRange().getValues();
  var customerId = null;
  var customerName = '';
  for (var i = 1; i < customerData.length; i++) {
    if (customerData[i][2] === email) {
      customerId = customerData[i][0];
      customerName = customerData[i][1];
      break;
    }
  }
  if (!customerId) return createResponse(false, 'Email c√≠m nem tal√°lhat√≥');

  // Find and verify the booking
  var bookingsSheet = ss.getSheetByName(SHEETS.BOOKINGS);
  var bookingsData = bookingsSheet.getDataRange().getValues();
  var bookingRow = -1;
  var bookingService = '', bookingDate = '', bookingTime = '';

  for (var j = 1; j < bookingsData.length; j++) {
    if (bookingsData[j][0] === bookingId && bookingsData[j][1] === customerId) {
      if (bookingsData[j][6] !== 'Confirmed') {
        return createResponse(false, 'Ez a foglal√°s m√°r nem akt√≠v');
      }
      bookingRow = j + 1;
      bookingService = bookingsData[j][3];
      bookingDate = typeof bookingsData[j][4] === 'string' ? bookingsData[j][4].slice(0,10) : formatDate(new Date(bookingsData[j][4]));
      bookingTime = formatTimeFromSheet(bookingsData[j][5]);
      var calendarEventId = bookingsData[j][10] || '';
      var stripePaymentIntentId = bookingsData[j][11] || '';
      break;
    }
  }

  if (bookingRow === -1) return createResponse(false, 'Foglal√°s nem tal√°lhat√≥');

  // Enforce 24h cancellation policy
  try {
    var bMs = new Date(bookingDate + 'T' + bookingTime + ':00').getTime();
    if ((bMs - Date.now()) < 24 * 60 * 60 * 1000) {
      return createResponse(false, 'A foglal√°st legk√©s≈ëbb 24 √≥r√°val kor√°bban lehet lemondani.');
    }
  } catch(e) { /* date parsing edge case, continue */ }

  // Mark as cancelled in sheet
  bookingsSheet.getRange(bookingRow, 7).setValue('Cancelled');
  SpreadsheetApp.flush();
  var calendarDeleted = false;
  try {
    calendarDeleted = deleteCalendarEvent_(calendarEventId, bookingDate, bookingTime, customerName);
  } catch (calErr) {
    Logger.log('Calendar deletion skipped: ' + calErr);
  }

  // Attempt Stripe refund if we have a payment intent ID
  var refundStatus = 'Nincs Stripe fizet√©si adat ‚Äì manu√°lis visszat√©r√≠t√©s sz√ºks√©ges';
  var refundAmount = '';
  if (stripePaymentIntentId) {
    try {
      var STRIPE_SECRET_KEY = PropertiesService.getScriptProperties().getProperty('STRIPE_SECRET_KEY');
      var refundResp = UrlFetchApp.fetch('https://api.stripe.com/v1/refunds', {
        method: 'POST',
        headers: { 'Authorization': 'Bearer ' + STRIPE_SECRET_KEY, 'Content-Type': 'application/x-www-form-urlencoded' },
        payload: 'payment_intent=' + encodeURIComponent(stripePaymentIntentId),
        muteHttpExceptions: true
      });
      var refundJson = JSON.parse(refundResp.getContentText());
      if (refundJson.id) {
        refundAmount = (refundJson.amount / 100).toLocaleString() + ' Ft';
        refundStatus = '‚úÖ STRIPE VISSZAT√âR√çT√âS SIKERES ‚Äì ' + refundAmount + ' (refund ID: ' + refundJson.id + ')';
        Logger.log('Stripe refund issued: ' + refundJson.id + ' for ' + stripePaymentIntentId);
      } else {
        refundStatus = '‚ö†Ô∏è Stripe visszat√©r√≠t√©s sikertelen: ' + JSON.stringify(refundJson) + ' ‚Äì manu√°lis visszat√©r√≠t√©s sz√ºks√©ges!';
        Logger.log('Stripe refund failed: ' + JSON.stringify(refundJson));
      }
    } catch (refErr) {
      refundStatus = '‚ö†Ô∏è Stripe API hiba: ' + refErr + ' ‚Äì manu√°lis visszat√©r√≠t√©s sz√ºks√©ges!';
      Logger.log('Stripe refund error: ' + refErr);
    }
  }

  // Notify Edina
  var edinaSubject = 'üî¥ √úgyf√©l mondta le ‚Äì ' + customerName + ' (' + bookingDate + ' ' + bookingTime + ')';
  var edinaBody = 'Kedves Edina!\n\n';
  edinaBody += customerName + ' lemondta a foglal√°s√°t a weboldalon kereszt√ºl:\n\n';
  edinaBody += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n';
  edinaBody += 'üë§ N√©v: ' + customerName + '\n';
  edinaBody += 'üìß Email: ' + email + '\n';
  edinaBody += 'üíÜ Kezel√©s: ' + bookingService + '\n';
  edinaBody += 'üìÖ D√°tum: ' + bookingDate + '\n';
  edinaBody += '‚è∞ Id≈ëpont: ' + bookingTime + '\n';
  if (reason) edinaBody += 'üìù Indokl√°s: ' + reason + '\n';
  edinaBody += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n';
  edinaBody += 'üí≥ VISSZAT√âR√çT√âS: ' + refundStatus + '\n\n';
  if (calendarDeleted) {
    edinaBody += '‚úÖ A Google Napt√°r esem√©ny automatikusan t√∂r√∂lve.';
  } else {
    edinaBody += '‚ö†Ô∏è A napt√°ri esem√©ny nem volt autom√°n t√∂r√∂lhet≈ë ‚Äì k√©rj√ºk ellen≈ërizd manu√°lisan a Google Napt√°rt!';
  }

  MailApp.sendEmail({ to: 'dunakeszimasszor@gmail.com', subject: edinaSubject, body: edinaBody, name: 'Dunakeszi Massz√°zs - Admin', replyTo: 'dunakeszimasszor@gmail.com' });

  // Confirm to customer
  var custSubject = 'Foglal√°s lemondva ‚Äì Dunakeszi Massz√°zs';
  var custBody = 'Kedves ' + customerName + '!\n\n';
  custBody += 'Foglal√°sod sikeresen lemondva:\n\n';
  custBody += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n';
  custBody += 'üíÜ Kezel√©s: ' + bookingService + '\n';
  custBody += 'üìÖ D√°tum: ' + bookingDate + '\n';
  custBody += '‚è∞ Id≈ëpont: ' + bookingTime + '\n';
  custBody += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n';
  if (stripePaymentIntentId) {
    if (refundStatus.indexOf('SIKERES') !== -1) {
      custBody += 'üí≥ A befizetett foglal√°si d√≠j (' + refundAmount + ') visszautal√°sra ker√ºl a bankk√°rty√°dra.\n';
      custBody += '   Az √∂sszeg √°ltal√°ban 5‚Äì10 munkanapon bel√ºl megjelenik a sz√°ml√°don.\n\n';
    } else {
      custBody += 'üí≥ A visszat√©r√≠t√©ssel kapcsolatban hamarosan felvessz√ºk veled a kapcsolatot.\n\n';
    }
  }
  custBody += 'Ha √∫j id≈ëpontot szeretn√©l foglalni:\n';
  custBody += 'üåê https://dunakeszimasszazs.hu/#idopont\n\n';
  custBody += '√údv√∂zlettel,\nMakra Edina\nDunakeszi Massz√°zs - Angyali Szalon\nüìû +36 30 487 7883';

  MailApp.sendEmail({ to: email, subject: custSubject, body: custBody, name: 'Dunakeszi Massz√°zs - Angyali Szalon', replyTo: 'dunakeszimasszor@gmail.com' });

  return createResponse(true, 'Foglal√°sod sikeresen lemondva! Visszaigazol√°st k√ºld√ºnk emailben.');
}

function selfRequestChange_(data) {
  var bookingId = data.bookingId;
  var email = data.email;
  var newDate = data.newDate;
  var newTime = data.newTime;
  var notes = data.notes || '';

  if (!bookingId || !email || !newDate || !newTime) return createResponse(false, 'Hi√°nyz√≥ adatok');

  var ss = SpreadsheetApp.getActiveSpreadsheet();

  // Find customer by email
  var customersSheet = ss.getSheetByName(SHEETS.CUSTOMERS);
  var customerData = customersSheet.getDataRange().getValues();
  var customerId = null;
  var customerName = '';
  for (var i = 1; i < customerData.length; i++) {
    if (customerData[i][2] === email) {
      customerId = customerData[i][0];
      customerName = customerData[i][1];
      break;
    }
  }
  if (!customerId) return createResponse(false, 'Email c√≠m nem tal√°lhat√≥');

  // Find the booking
  var bookingsSheet = ss.getSheetByName(SHEETS.BOOKINGS);
  var bookingsData = bookingsSheet.getDataRange().getValues();
  var bookingService = '', bookingDate = '', bookingTime = '', calEventId = '';
  var bookingRow = -1;

  for (var j = 1; j < bookingsData.length; j++) {
    if (bookingsData[j][0] === bookingId && bookingsData[j][1] === customerId) {
      bookingService = bookingsData[j][3];
      bookingDate = typeof bookingsData[j][4] === 'string' ? bookingsData[j][4].slice(0,10) : formatDate(new Date(bookingsData[j][4]));
      bookingTime = formatTimeFromSheet(bookingsData[j][5]);
      calEventId = bookingsData[j][10] || '';
      bookingRow = j + 1;
      break;
    }
  }

  if (!bookingDate) return createResponse(false, 'Foglal√°s nem tal√°lhat√≥');

  // Enforce 24h change policy
  try {
    var bMs = new Date(bookingDate + 'T' + bookingTime + ':00').getTime();
    if ((bMs - Date.now()) < 24 * 60 * 60 * 1000) {
      return createResponse(false, 'A foglal√°st legk√©s≈ëbb 24 √≥r√°val kor√°bban lehet m√≥dos√≠tani.');
    }
  } catch(e) { /* date parsing edge case, continue */ }

  // Check if customer already has another booking at the requested new date+time
  for (var k = 1; k < bookingsData.length; k++) {
    if (bookingsData[k][0] !== bookingId && bookingsData[k][1] === customerId &&
        (bookingsData[k][6] === 'Confirmed' || bookingsData[k][6] === 'ChangeRequested')) {
      var chkDate = typeof bookingsData[k][4] === 'string' ? bookingsData[k][4].slice(0,10) : formatDate(new Date(bookingsData[k][4]));
      var chkTime = formatTimeFromSheet(bookingsData[k][5]);
      if (chkDate === newDate && chkTime === newTime) {
        return createResponse(false, 'Ezen az id≈ëponton m√°r van akt√≠v foglal√°sod! K√©rj√ºk v√°lassz m√°sik id≈ëpontot.');
      }
    }
  }

  // Mark booking as ChangeRequested so it shows as pending in the customer list
  if (bookingRow > 0) {
    bookingsSheet.getRange(bookingRow, 7).setValue('ChangeRequested');
    SpreadsheetApp.flush();
  }

  // Flag the Google Calendar event (non-fatal ‚Äì never crash the change request)
  try {
    flagCalendarEventForChange_(calEventId, bookingDate, bookingTime, customerName, newDate, newTime);
  } catch (calErr) {
    Logger.log('Calendar flagging skipped: ' + calErr);
  }

  // Notify Edina with change request
  var edinaSubject = 'üìù Id≈ëpont m√≥dos√≠t√°si k√©relem ‚Äì ' + customerName;
  var edinaBody = 'Kedves Edina!\n\n';
  edinaBody += customerName + ' id≈ëpont-m√≥dos√≠t√°st k√©r:\n\n';
  edinaBody += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n';
  edinaBody += 'üë§ N√©v: ' + customerName + '\n';
  edinaBody += 'üìß Email: ' + email + '\n';
  edinaBody += 'üíÜ Kezel√©s: ' + bookingService + '\n\n';
  edinaBody += '‚ùå JELENLEGI ID≈êPONT:\n';
  edinaBody += '   üìÖ ' + bookingDate + ' ' + bookingTime + '\n\n';
  edinaBody += '‚úÖ K√âRT √öj ID≈êPONT:\n';
  edinaBody += '   üìÖ ' + newDate + ' ' + newTime + '\n';
  if (notes) edinaBody += '\nüìù Megjegyz√©s: ' + notes + '\n';
  edinaBody += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n';
  edinaBody += 'K√©rj√ºk, er≈ës√≠tsd meg az √ºgyf√©lnek az √∫j id≈ëpontot!';

  MailApp.sendEmail({ to: 'dunakeszimasszor@gmail.com', subject: edinaSubject, body: edinaBody, name: 'Dunakeszi Massz√°zs - Admin', replyTo: 'dunakeszimasszor@gmail.com' });

  // Pending confirmation to customer
  var custSubject = 'Id≈ëpont m√≥dos√≠t√°si k√©relem elk√ºldve ‚Äì Dunakeszi Massz√°zs';
  var custBody = 'Kedves ' + customerName + '!\n\n';
  custBody += 'M√≥dos√≠t√°si k√©relmed meg√©rkezett.\n\n';
  custBody += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n';
  custBody += 'üíÜ Kezel√©s: ' + bookingService + '\n\n';
  custBody += '‚ùå Jelenlegi id≈ëpont: ' + bookingDate + ' ' + bookingTime + '\n';
  custBody += '‚úÖ K√©rt √∫j id≈ëpont: ' + newDate + ' ' + newTime + '\n';
  if (notes) custBody += 'üìù Megjegyz√©s: ' + notes + '\n';
  custBody += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n';
  custBody += 'Hamarosan visszajelz√ºnk a m√≥dos√≠t√°s visszaigazol√°s√°val!\n\n';
  custBody += '√údv√∂zlettel,\nMakra Edina\nDunakeszi Massz√°zs - Angyali Szalon\nüìû +36 30 487 7883';

  MailApp.sendEmail({ to: email, subject: custSubject, body: custBody, name: 'Dunakeszi Massz√°zs - Angyali Szalon', replyTo: 'dunakeszimasszor@gmail.com' });

  return createResponse(true, 'M√≥dos√≠t√°si k√©relmed elk√ºldve! Hamarosan √©rtes√≠t√ºnk a visszaigazol√°ssal.');
}

// ============================================
// Calendar Helper Functions
// ============================================

// Tries to delete a Google Calendar event by its stored ID.
// Falls back to searching by date/time window + customer name if ID is missing.
function deleteCalendarEvent_(calendarEventId, bookingDate, bookingTime, customerName) {
  var calendar;
  try { calendar = CalendarApp.getDefaultCalendar(); } catch(e) {
    Logger.log('CalendarApp unavailable in deleteCalendarEvent_: ' + e);
    return false;
  }

  // Primary: delete by stored event ID
  if (calendarEventId) {
    try {
      var evt = calendar.getEventById(calendarEventId);
      if (evt) {
        evt.deleteEvent();
        Logger.log('Calendar event deleted by ID: ' + calendarEventId);
        return true;
      }
    } catch (e) {
      Logger.log('Could not delete by ID, falling back to search: ' + e);
    }
  }

  // Fallback: search for events within ¬±2 minutes of the booking slot
  try {
    var parts = bookingTime.split(':');
    var start = new Date(bookingDate + 'T' + (parts[0] || '00') + ':' + (parts[1] || '00') + ':00');
    var searchStart = new Date(start.getTime() - 2 * 60000);
    var searchEnd   = new Date(start.getTime() + 2 * 60000);
    var events = calendar.getEvents(searchStart, searchEnd);
    for (var i = 0; i < events.length; i++) {
      var title = events[i].getTitle();
      if (title.indexOf(customerName) !== -1 || title.indexOf('Massz√°zs') !== -1) {
        events[i].deleteEvent();
        Logger.log('Calendar event deleted by search: ' + title);
        return true;
      }
    }
  } catch (e) {
    Logger.log('Fallback calendar search failed: ' + e);
  }

  Logger.log('Calendar event not found for: ' + customerName + ' ' + bookingDate + ' ' + bookingTime);
  return false;
}

// Flags a Google Calendar event to visually show a pending change request.
// Updates the event title and adds the new requested date/time to the description.
function flagCalendarEventForChange_(calendarEventId, bookingDate, bookingTime, customerName, newDate, newTime) {
  var calendar;
  try { calendar = CalendarApp.getDefaultCalendar(); } catch(e) {
    Logger.log('CalendarApp unavailable in flagCalendarEventForChange_: ' + e);
    return false;
  }
  var changeNote = 'M√ìDOS√çT√ÅS K√âRT: ' + newDate + ' ' + newTime;

  // Primary: update by stored event ID
  if (calendarEventId) {
    try {
      var evt = calendar.getEventById(calendarEventId);
      if (evt) {
        evt.setTitle('‚ö†Ô∏è ' + changeNote + ' | ' + evt.getTitle());
        var desc = evt.getDescription() || '';
        evt.setDescription('‚ö†Ô∏è √úgyf√©l m√≥dos√≠t√°st k√©rt!\nK√©rt √∫j id≈ëpont: ' + newDate + ' ' + newTime + '\n\n' + desc);
        Logger.log('Calendar event flagged by ID: ' + calendarEventId);
        return true;
      }
    } catch (e) {
      Logger.log('Could not flag by ID, falling back to search: ' + e);
    }
  }

  // Fallback: search ¬±2 minutes
  try {
    var parts = bookingTime.split(':');
    var start = new Date(bookingDate + 'T' + (parts[0] || '00') + ':' + (parts[1] || '00') + ':00');
    var searchStart = new Date(start.getTime() - 2 * 60000);
    var searchEnd   = new Date(start.getTime() + 2 * 60000);
    var events = calendar.getEvents(searchStart, searchEnd);
    for (var i = 0; i < events.length; i++) {
      var title = events[i].getTitle();
      if (title.indexOf(customerName) !== -1) {
        events[i].setTitle('‚ö†Ô∏è ' + changeNote + ' | ' + title);
        var desc = events[i].getDescription() || '';
        events[i].setDescription('‚ö†Ô∏è √úgyf√©l m√≥dos√≠t√°st k√©rt!\nK√©rt √∫j id≈ëpont: ' + newDate + ' ' + newTime + '\n\n' + desc);
        Logger.log('Calendar event flagged by search: ' + title);
        return true;
      }
    }
  } catch (e) {
    Logger.log('Fallback flag search failed: ' + e);
  }

  return false;
}

// ============================================
// P&L Dashboard
// ============================================
// Internal helper ‚Äì returns a plain object (no ContentService wrapping).
// Used by both getPnL() and getDashboardData().
function getPnLData_(month, year) {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var financialSheet = ss.getSheetByName(SHEETS.FINANCIAL);
  var txnData = financialSheet.getDataRange().getValues();
  
  var monthlyIncome = 0;
  var monthlyDeposits = 0;
  var estimatedFullRevenue = 0;
  
  var transactions = [];
  
  for (var i = 1; i < txnData.length; i++) {
    var txnDate = new Date(txnData[i][1]);
    if (txnDate.getMonth() + 1 === parseInt(month) && txnDate.getFullYear() === parseInt(year)) {
      var amount = txnData[i][6];
      var type = txnData[i][2];
      
      if (type === 'Income' || type === 'Payment') {
        monthlyIncome += amount;
        // Payment = 20% deposit ‚Üí estimate full session value
        if (type === 'Payment') {
          estimatedFullRevenue += amount * 5;
        } else {
          estimatedFullRevenue += amount;
        }
      } else if (type === 'Deposit') {
        monthlyDeposits += amount;
      }
      
      transactions.push({
        date: txnData[i][1],
        type: type,
        customer: txnData[i][4],
        description: txnData[i][5],
        amount: amount
      });
    }
  }
  
  // Get session stats
  var bookingsSheet = ss.getSheetByName(SHEETS.BOOKINGS);
  var bookingsData = bookingsSheet.getDataRange().getValues();
  var sessionsCompleted = 0;
  
  for (var j = 1; j < bookingsData.length; j++) {
    var bookingDate = new Date(bookingsData[j][4]);
    if (bookingDate.getMonth() + 1 === parseInt(month) && 
        bookingDate.getFullYear() === parseInt(year) &&
        bookingsData[j][6] === 'Confirmed') {
      sessionsCompleted++;
    }
  }
  
  return {
    month: month,
    year: year,
    totalIncome: monthlyIncome,
    totalDeposits: monthlyDeposits,
    estimatedFullRevenue: estimatedFullRevenue,
    outstanding: monthlyIncome - monthlyDeposits,
    sessionsCompleted: sessionsCompleted,
    transactions: transactions
  };
}

// Range-based P&L (used for day and week views)
function getPnLDataRange_(startDateStr, endDateStr) {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var financialSheet = ss.getSheetByName(SHEETS.FINANCIAL);
  var txnData = financialSheet.getDataRange().getValues();

  var startDate = new Date(startDateStr);
  startDate.setHours(0, 0, 0, 0);
  var endDate = new Date(endDateStr);
  endDate.setHours(23, 59, 59, 999);

  var totalIncome = 0;
  var totalDeposits = 0;
  var estimatedFullRevenue = 0;
  var transactions = [];

  for (var i = 1; i < txnData.length; i++) {
    var txnDate = new Date(txnData[i][1]);
    if (txnDate >= startDate && txnDate <= endDate) {
      var amount = txnData[i][6];
      var type = txnData[i][2];
      if (type === 'Income' || type === 'Payment') {
        totalIncome += amount;
        if (type === 'Payment') {
          estimatedFullRevenue += amount * 5;
        } else {
          estimatedFullRevenue += amount;
        }
      } else if (type === 'Deposit') {
        totalDeposits += amount;
      }
      transactions.push({
        date: txnData[i][1],
        type: type,
        customer: txnData[i][4],
        description: txnData[i][5],
        amount: amount
      });
    }
  }

  var bookingsSheet = ss.getSheetByName(SHEETS.BOOKINGS);
  var bookingsData = bookingsSheet.getDataRange().getValues();
  var sessionsCompleted = 0;
  for (var j = 1; j < bookingsData.length; j++) {
    var bookingDate = new Date(bookingsData[j][4]);
    if (bookingDate >= startDate && bookingDate <= endDate && bookingsData[j][6] === 'Confirmed') {
      sessionsCompleted++;
    }
  }

  return {
    totalIncome: totalIncome,
    totalDeposits: totalDeposits,
    estimatedFullRevenue: estimatedFullRevenue,
    outstanding: totalIncome - totalDeposits,
    sessionsCompleted: sessionsCompleted,
    transactions: transactions
  };
}

function getPnL(data) {
  var mode = data.mode || 'month';
  if (mode === 'day' && data.date) {
    return createResponse(true, 'P&L adatok', getPnLDataRange_(data.date, data.date));
  } else if (mode === 'week' && data.weekStart) {
    var startDate = new Date(data.weekStart);
    var endDate = new Date(startDate);
    endDate.setDate(endDate.getDate() + 6);
    var endStr = Utilities.formatDate(endDate, Session.getScriptTimeZone(), 'yyyy-MM-dd');
    return createResponse(true, 'P&L adatok', getPnLDataRange_(data.weekStart, endStr));
  } else {
    var month = data.month || new Date().getMonth() + 1;
    var year = data.year || new Date().getFullYear();
    return createResponse(true, 'P&L adatok', getPnLData_(month, year));
  }
}

function getDashboardData() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  
  // Get customer count
  var customersSheet = ss.getSheetByName(SHEETS.CUSTOMERS);
  var customerCount = customersSheet.getLastRow() - 1;
  
  // Get active packages count
  var packagesSheet = ss.getSheetByName(SHEETS.SESSION_PACKAGES);
  var packagesData = packagesSheet.getDataRange().getValues();
  var activePackages = 0;
  var totalSessionsRemaining = 0;
  
  for (var i = 1; i < packagesData.length; i++) {
    if (packagesData[i][13] === 'Active') {
      activePackages++;
      totalSessionsRemaining += packagesData[i][7];
    }
  }
  
  // Get today's bookings
  var bookingsSheet = ss.getSheetByName(SHEETS.BOOKINGS);
  var bookingsData = bookingsSheet.getDataRange().getValues();
  var today = formatDate(new Date());
  var todaysBookings = [];
  
  for (var j = 1; j < bookingsData.length; j++) {
    if (bookingsData[j][4] === today) {
      todaysBookings.push({
        customer: bookingsData[j][2],
        service: bookingsData[j][3],
        time: bookingsData[j][5]
      });
    }
  }
  
  // Get current month P&L
  var pnlData = getPnLData_(new Date().getMonth() + 1, new Date().getFullYear());
  
  return createResponse(true, 'Dashboard adatok', {
    customerCount: customerCount,
    activePackages: activePackages,
    totalSessionsRemaining: totalSessionsRemaining,
    todaysBookings: todaysBookings,
    monthlyPnL: pnlData
  });
}

// ============================================
// Cancellation & Change Handlers
// ============================================
function handleCancellation(data) {
  if (!data.clientName || !data.clientEmail || !data.appointmentDate || !data.appointmentTime) {
    return createResponse(false, 'Hi√°nyz√≥ k√∂telez≈ë mez≈ëk');
  }
  
  // Send cancellation email to customer
  var subject = 'Id≈ëpont lemondva - Dunakeszi Massz√°zs';
  var body = 'Kedves ' + data.clientName + '!\n\n' +
             '√ârtes√≠tlek, hogy az al√°bbi id≈ëpontod lemond√°sra ker√ºlt:\n\n' +
             '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n' +
             'üíÜ Kezel√©s: ' + (data.service || 'Nincs megadva') + '\n' +
             'üìÖ D√°tum: ' + data.appointmentDate + '\n' +
             '‚è∞ Id≈ëpont: ' + data.appointmentTime + '\n' +
             '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n';
  
  if (data.reason) {
    body += 'Indokl√°s: ' + data.reason + '\n\n';
  }
  
  body += 'Ha szeretn√©l √∫j id≈ëpontot foglalni, k√©rem, l√°togass el a weboldalra vagy h√≠vj telefonon.\n\n' +
          'üìû +36 30 487 7883\n' +
          'üåê https://dunakeszimasszazs.hu\n\n' +
          '√údv√∂zlettel,\n' +
          'Makra Edina\n' +
          'Dunakeszi Massz√°zs - Angyali Szalon';
  
  MailApp.sendEmail({
    to: data.clientEmail,
    subject: subject,
    body: body,
    name: 'Dunakeszi Massz√°zs - Angyali Szalon',
    replyTo: 'dunakeszimasszor@gmail.com'
  });
  
  // Send notification to Edina
  var edinaSubject = 'Id≈ëpont lemondva - ' + data.clientName;
  var edinaBody = 'Kedves Edina!\n\n' +
                  'Egy id≈ëpont lemond√°sra ker√ºlt:\n\n' +
                  '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n' +
                  'üë§ N√©v: ' + data.clientName + '\n' +
                  'üìß Email: ' + data.clientEmail + '\n' +
                  'üíÜ Kezel√©s: ' + (data.service || 'Nincs megadva') + '\n' +
                  'üìÖ D√°tum: ' + data.appointmentDate + '\n' +
                  '‚è∞ Id≈ëpont: ' + data.appointmentTime + '\n' +
                  '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n';
  
  if (data.reason) {
    edinaBody += 'Indokl√°s: ' + data.reason + '\n\n';
  }
  
  edinaBody += 'Ne felejtsd el t√∂r√∂lni az id≈ëpontot a Google Napt√°rb√≥l!';
  
  MailApp.sendEmail({
    to: 'dunakeszimasszor@gmail.com',
    subject: edinaSubject,
    body: edinaBody,
    name: 'Dunakeszi Massz√°zs - Admin',
    replyTo: 'dunakeszimasszor@gmail.com'
  });
  
  return createResponse(true, 'Lemond√°si √©rtes√≠t√©s elk√ºldve!');
}

function handleChange(data) {
  if (!data.clientName || !data.clientEmail || !data.appointmentDate || !data.appointmentTime || !data.newDate || !data.newTime) {
    return createResponse(false, 'Hi√°nyz√≥ k√∂telez≈ë mez≈ëk');
  }
  
  // Send change email to customer
  var subject = 'Id≈ëpont m√≥dos√≠tva - Dunakeszi Massz√°zs';
  var body = 'Kedves ' + data.clientName + '!\n\n' +
             '√ârtes√≠tlek, hogy az id≈ëpontod m√≥dos√≠t√°sra ker√ºlt:\n\n' +
             '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n' +
             '‚ùå EREDETI ID≈êPONT:\n' +
             'üìÖ D√°tum: ' + data.appointmentDate + '\n' +
             '‚è∞ Id≈ëpont: ' + data.appointmentTime + '\n\n' +
             '‚úÖ √öJ ID≈êPONT:\n' +
             'üìÖ D√°tum: ' + data.newDate + '\n' +
             '‚è∞ Id≈ëpont: ' + data.newTime + '\n' +
             'üíÜ Kezel√©s: ' + (data.service || 'Nincs megadva') + '\n' +
             '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n' +
             'üìç C√çM √âS MEGK√ñZEL√çT√âS:\n' +
             'Dunakeszi, Kolonics Gy√∂rgy utca 2/B, 2120\n' +
             'Kapucseng≈ë: 1/43\n\n' +
             'Ha k√©rd√©sed van, h√≠vj b√°tran:\n' +
             'üìû +36 30 487 7883\n\n' +
             'V√°rlak szeretettel az Angyali Szalonban!\n\n' +
             '√údv√∂zlettel,\n' +
             'Makra Edina\n' +
             'Dunakeszi Massz√°zs - Angyali Szalon';
  
  MailApp.sendEmail({
    to: data.clientEmail,
    subject: subject,
    body: body,
    name: 'Dunakeszi Massz√°zs - Angyali Szalon',
    replyTo: 'dunakeszimasszor@gmail.com'
  });
  
  // Send notification to Edina
  var edinaSubject = 'Id≈ëpont m√≥dos√≠tva - ' + data.clientName;
  var edinaBody = 'Kedves Edina!\n\n' +
                  'Egy id≈ëpont m√≥dos√≠t√°sra ker√ºlt:\n\n' +
                  '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n' +
                  'üë§ N√©v: ' + data.clientName + '\n' +
                  'üìß Email: ' + data.clientEmail + '\n' +
                  'üíÜ Kezel√©s: ' + (data.service || 'Nincs megadva') + '\n\n' +
                  '‚ùå EREDETI:\n' +
                  'üìÖ ' + data.appointmentDate + ' ' + data.appointmentTime + '\n\n' +
                  '‚úÖ √öJ:\n' +
                  'üìÖ ' + data.newDate + ' ' + data.newTime + '\n' +
                  '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n' +
                  'Ne felejtsd el friss√≠teni az id≈ëpontot a Google Napt√°rb√≥l!';
  
  MailApp.sendEmail({
    to: 'dunakeszimasszor@gmail.com',
    subject: edinaSubject,
    body: edinaBody,
    name: 'Dunakeszi Massz√°zs - Admin',
    replyTo: 'dunakeszimasszor@gmail.com'
  });
  
  return createResponse(true, 'M√≥dos√≠t√°si √©rtes√≠t√©s elk√ºldve!');
}

// ============================================
// Email Functions
// ============================================
function sendBookingConfirmationToEdina(data, recurringCount, recurringType, recurringDates, discountPercent, packageId) {
  var edinaSubject = recurringCount > 1 
    ? '√öj ism√©tl≈ëd≈ë foglal√°s - Angyali Szalon (' + data.name + ', ' + recurringCount + ' alkalom)'
    : '√öj id≈ëpontfoglal√°s - Angyali Szalon (' + data.name + ')';
  
  var edinaBody = 'Kedves Edina!\n\n';
  
  if (recurringCount > 1) {
    edinaBody += '√öj ISM√âTL≈êD≈ê foglal√°s √©rkezett a weboldalr√≥l:\n\n';
    edinaBody += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n';
    edinaBody += 'üë§ N√âV: ' + data.name + '\n';
    edinaBody += 'üìû TELEFON: ' + (data.phone || 'Nincs megadva') + '\n';
    edinaBody += 'üìß EMAIL: ' + data.email + '\n';
    edinaBody += 'üíÜ KEZEL√âS: ' + data.service + '\n';
    edinaBody += 'üìÖ ELS≈ê D√ÅTUM: ' + data.date + '\n';
    edinaBody += '‚è∞ ID≈êPONT: ' + data.time + '\n';
    edinaBody += 'üîÑ ISM√âTL≈êD√âS: ' + getRecurringTypeText(recurringType) + '\n';
    edinaBody += 'üìä ALKALMAK SZ√ÅMA: ' + recurringCount + '\n';
    if (discountPercent > 0) {
      edinaBody += 'üí∞ KEDVEZM√âNY: ' + discountPercent + '%\n';
    }
    if (packageId) {
      edinaBody += 'üé´ B√âRLET: ' + packageId + '\n';
    }
    edinaBody += 'üìã √ñSSZES D√ÅTUM:\n';
    for (var j = 0; j < recurringDates.length; j++) {
      edinaBody += '   ' + (j + 1) + '. ' + recurringDates[j] + '\n';
    }
    edinaBody += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n';
  } else {
    edinaBody += '√öj id≈ëpontfoglal√°s √©rkezett a weboldalr√≥l:\n\n';
    edinaBody += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n';
    edinaBody += 'üë§ N√âV: ' + data.name + '\n';
    edinaBody += 'üìû TELEFON: ' + (data.phone || 'Nincs megadva') + '\n';
    edinaBody += 'üìß EMAIL: ' + data.email + '\n';
    edinaBody += 'üíÜ KEZEL√âS: ' + data.service + '\n';
    edinaBody += 'üìÖ D√ÅTUM: ' + data.date + '\n';
    edinaBody += '‚è∞ ID≈êPONT: ' + data.time + '\n';
    if (packageId) {
      edinaBody += 'üé´ B√âRLET: ' + packageId + '\n';
    }
    edinaBody += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n';
  }
  
  edinaBody += 'üìù MEGJEGYZ√âS: ' + (data.notes || 'Nincs megadva') + '\n\n';
  edinaBody += 'A foglal√°s(ok) automatikusan hozz√°adva lettek a Google Napt√°radhoz.\n\n';
  edinaBody += '√údv√∂zlettel,\n';
  edinaBody += 'Dunakeszi Massz√°zs Weboldal';
  
  MailApp.sendEmail({
    to: 'dunakeszimasszor@gmail.com',
    subject: edinaSubject,
    body: edinaBody,
    name: 'Dunakeszi Massz√°zs - Foglal√°si Rendszer',
    replyTo: 'dunakeszimasszor@gmail.com'
  });
}

function sendBookingConfirmationToCustomer(data, recurringCount, recurringType, recurringDates, discountPercent, packageId, customer) {
  var customerSubject = recurringCount > 1
    ? 'Ism√©tl≈ëd≈ë id≈ëpontfoglal√°s visszaigazol√°s - Dunakeszi Massz√°zs'
    : 'Id≈ëpontfoglal√°s visszaigazol√°s - Dunakeszi Massz√°zs';
  
  var customerBody = 'Kedves ' + data.name + '!\n\n';
  customerBody += 'K√∂sz√∂n√∂m az id≈ëpontfoglal√°sodat!\n\n';
  
  // Calculate price breakdown
  var servicePricePerSession = (data.service && data.service.toLowerCase().indexOf('arany') !== -1) ? 30000 : 15000;
  var totalServicePrice = servicePricePerSession * recurringCount;
  var discountAmount = discountPercent > 0 ? Math.round(totalServicePrice * discountPercent / 100) : 0;
  var discountedTotal = totalServicePrice - discountAmount;
  var depositPaid = data.amount ? Math.round(data.amount) : Math.round(discountedTotal * 0.2);
  var remainingAmount = discountedTotal - depositPaid;

  if (recurringCount > 1) {
    customerBody += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n';
    customerBody += 'üíÜ KEZEL√âS: ' + data.service + '\n';
    customerBody += 'üìÖ ELS≈ê D√ÅTUM: ' + data.date + '\n';
    customerBody += '‚è∞ ID≈êPONT: ' + data.time + '\n';
    customerBody += 'üîÑ ISM√âTL≈êD√âS: ' + getRecurringTypeText(recurringType) + '\n';
    customerBody += 'üìä ALKALMAK SZ√ÅMA: ' + recurringCount + '\n';
    customerBody += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n';
    customerBody += 'üí≥ √ÅR√ñSSZEGZ√âS:\n';
    customerBody += 'Kezel√©s √°ra (' + recurringCount + ' √ó ' + servicePricePerSession.toLocaleString() + ' Ft): ' + totalServicePrice.toLocaleString() + ' Ft\n';
    if (discountPercent > 0) {
      customerBody += 'Kedvezm√©ny (' + discountPercent + '%): -' + discountAmount.toLocaleString() + ' Ft\n';
    }
    if (!packageId) {
      customerBody += '√ñsszesen: ' + discountedTotal.toLocaleString() + ' Ft\n';
      customerBody += '‚úÖ Befizetett foglal√≥ (20%): ' + depositPaid.toLocaleString() + ' Ft\n';
      customerBody += 'üíµ H√°tral√©k (kezel√©skor): ' + remainingAmount.toLocaleString() + ' Ft\n';
    } else {
      customerBody += 'üé´ B√©rletb≈ël felhaszn√°lva\n';
    }
    customerBody += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n';
    customerBody += 'üìã AZ √ñSSZES FOGLALT ID≈êPONT:\n';
    for (var k = 0; k < recurringDates.length; k++) {
      customerBody += '   ' + (k + 1) + '. ' + recurringDates[k] + ' ' + data.time + '\n';
    }
    customerBody += '\n';
  } else {
    customerBody += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n';
    customerBody += 'üíÜ KEZEL√âS: ' + data.service + '\n';
    customerBody += 'üìÖ D√ÅTUM: ' + data.date + '\n';
    customerBody += '‚è∞ ID≈êPONT: ' + data.time + '\n';
    customerBody += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n';
    customerBody += 'üí≥ √ÅR√ñSSZEGZ√âS:\n';
    customerBody += 'Kezel√©s √°ra: ' + servicePricePerSession.toLocaleString() + ' Ft\n';
    if (!packageId) {
      customerBody += '‚úÖ Befizetett foglal√≥ (20%): ' + depositPaid.toLocaleString() + ' Ft\n';
      customerBody += 'üíµ H√°tral√©k (kezel√©skor): ' + remainingAmount.toLocaleString() + ' Ft\n';
    } else {
      customerBody += 'üé´ B√©rletb≈ël felhaszn√°lva\n';
    }
    customerBody += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n';
  }
  
  // Add remaining sessions info if customer has packages
  if (customer.totalSessionsRemaining > 0) {
    customerBody += 'üé´ B√âRLET EGYENLEG:\n';
    customerBody += 'H√°tral√©v≈ë alkalmak: ' + customer.totalSessionsRemaining + '\n\n';
  }
  
  customerBody += 'üìç C√çM √âS MEGK√ñZEL√çT√âS:\n';
  customerBody += 'Dunakeszi, Kolonics Gy√∂rgy utca 2/B, 2120\n';
  customerBody += 'Kapucseng≈ë: 1/43\n\n';
  customerBody += 'A kapun√°l a 1/43-as kapucseng≈ët kell megnyomni.\n\n';
  
  if (recurringCount > 1) {
    customerBody += '‚ö†Ô∏è FONTOS INFORM√ÅCI√ì ISM√âTL≈êD≈ê FOGLAL√ÅSHOZ:\n';
    customerBody += '‚Ä¢ Minden alkalom el≈ëtt 24 √≥r√°val eml√©keztet≈ët k√ºld√∂k\n';
    customerBody += '‚Ä¢ Ha b√°rmelyik alkalomra nem tudsz elj√∂nni, k√©rem, 24 √≥r√°val el≈ëtte jelezd\n';
    customerBody += '‚Ä¢ Az id≈ëpontok m√≥dos√≠that√≥k 24 √≥ra el≈ëtt ingyenesen\n';
    if (discountPercent > 0) {
      customerBody += '‚Ä¢ Kedvezm√©ny: ' + discountPercent + '% a t√∂bb alkalmas foglal√°s√©rt\n';
    }
    customerBody += '\n';
  }
  
  customerBody += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n';
  customerBody += 'üîó FOGLAL√ÅSAIDAT TE IS KEZELHETED ONLINE:\n';
  customerBody += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n';
  customerBody += '1Ô∏è‚É£  Nyisd meg: https://dunakeszimasszazs.hu/#foglalaskezeles\n';
  customerBody += '2Ô∏è‚É£  √çd be ezt az email c√≠met: ' + data.email + '\n';
  customerBody += '3Ô∏è‚É£  Megjelennek az √∂sszes k√∂zelg≈ë foglal√°said\n';
  customerBody += '4Ô∏è‚É£  Minden alkalom mell√© tal√°lsz ‚ÄùId≈ëpont m√≥dos√≠t√°sa‚Äù √©s ‚ÄùLemondas‚Äù gombot\n\n';
  customerBody += '‚ö†Ô∏è FONTOS: Lemondani vagy m√≥dos√≠t√°st k√©rni csak 24 √≥r√°val az alkalom el≈ëtt lehetk√©rni ingyenesen.\n\n';
  customerBody += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n';

  customerBody += 'Ha b√°rmilyen k√©rd√©sed van, h√≠vj b√°tran:\n';
  customerBody += 'üìû +36 30 487 7883\n\n';
  customerBody += 'V√°rlak szeretettel az Angyali Szalonban!\n\n';
  customerBody += '√údv√∂zlettel,\n';
  customerBody += 'Makra Edina\n';
  customerBody += 'Dunakeszi Massz√°zs - Angyali Szalon\n';
  customerBody += 'üìû +36 30 487 7883\n';
  customerBody += 'üìß dunakeszimasszor@gmail.com\n';
  customerBody += 'üåê https://dunakeszimasszazs.hu';
  
  MailApp.sendEmail({
    to: data.email,
    subject: customerSubject,
    body: customerBody,
    htmlBody: buildCustomerConfirmationHtml(data, recurringCount, recurringType, recurringDates, discountPercent, packageId, customer),
    name: 'Dunakeszi Massz√°zs - Angyali Szalon',
    replyTo: 'dunakeszimasszor@gmail.com'
  });
}

function sendPackagePurchaseConfirmation(customer, pkg) {
  var subject = 'B√©rlet v√°s√°rl√°s visszaigazol√°s - Dunakeszi Massz√°zs';
  
  var body = 'Kedves ' + customer.name + '!\n\n';
  body += 'K√∂sz√∂n√∂m a b√©rlet v√°s√°rl√°sodat!\n\n';
  body += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n';
  body += 'üé´ B√âRLET R√âSZLETEI:\n';
  body += 'B√©rlet sz√°ma: ' + pkg.packageId + '\n';
  body += 'Alkalmak sz√°ma: ' + pkg.sessions + '\n';
  body += 'Eredeti √°r: ' + pkg.originalPrice.toLocaleString() + ' Ft\n';
  if (pkg.discountPercent > 0) {
    body += 'Kedvezm√©ny: ' + pkg.discountPercent + '% (-' + pkg.discountAmount.toLocaleString() + ' Ft)\n';
  }
  body += 'Fizetend≈ë: ' + pkg.finalPrice.toLocaleString() + ' Ft\n';
  body += 'Foglal√≥ befizetve: ' + pkg.depositPaid.toLocaleString() + ' Ft\n';
  body += 'H√°tral√©k: ' + (pkg.finalPrice - pkg.depositPaid).toLocaleString() + ' Ft\n';
  body += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n';
  
  body += 'Hogyan haszn√°lhatod a b√©rletet:\n';
  body += '‚Ä¢ Foglalj id≈ëpontot a weboldalon vagy telefonon\n';
  body += '‚Ä¢ A rendszer automatikusan levon egy alkalmat a b√©rletedb≈ël\n';
  body += '‚Ä¢ A h√°tral√©kot az els≈ë kezel√©sn√©l kell kifizetni\n\n';
  
  body += 'B√©rlet egyenleged: ' + (customer.totalSessionsRemaining + pkg.sessions) + ' alkalom\n\n';
  
  body += 'Ha k√©rd√©sed van, h√≠vj b√°tran:\n';
  body += 'üìû +36 30 487 7883\n\n';
  body += '√údv√∂zlettel,\n';
  body += 'Makra Edina\n';
  body += 'Dunakeszi Massz√°zs - Angyali Szalon';
  
  MailApp.sendEmail({
    to: customer.email,
    subject: subject,
    body: body,
    name: 'Dunakeszi Massz√°zs - Angyali Szalon',
    replyTo: 'dunakeszimasszor@gmail.com'
  });
}

// ============================================
// Stripe Webhook Handler
// ============================================
// Configure in Stripe Dashboard ‚Üí Developers ‚Üí Webhooks ‚Üí Add endpoint
// Endpoint URL: your Google Apps Script web app URL
// Events to listen for: checkout.session.completed
function handleStripeWebhook(event) {
  try {
    Logger.log('Stripe webhook received: ' + event.type);

    if (event.type === 'checkout.session.completed') {
      var session = event.data.object;
      var metadata = session.metadata || {};

      // Build booking data from Stripe session metadata
      var bookingData = {
        name: metadata.customer_name || '',
        email: metadata.customer_email || session.customer_email || '',
        phone: metadata.customer_phone || '',
        service: metadata.service || '',
        date: metadata.date || '',
        time: metadata.time || '',
        notes: metadata.notes || '',
        recurring: metadata.recurring || 'no',
        recurringType: metadata.recurring_type || 'weekly',
        recurringCount: metadata.recurring_count || '1',
        usePackage: 'false',
        stripePaymentIntentId: session.payment_intent || ''
      };

      Logger.log('Creating booking from webhook: ' + JSON.stringify(bookingData));

      // Create the actual booking: calendar event, spreadsheet record, emails
      createBooking(bookingData);

      // Mark the pending booking row as paid
      updatePendingBookingStatus(bookingData.email, 'paid');

      // Record the payment in the Financial sheet
      recordTransaction(
        new Date(),
        'Payment',
        '',
        bookingData.name,
        'Stripe foglal√°si d√≠j - ' + bookingData.service,
        Math.round(session.amount_total / 100), // fill√©r ‚Üí Ft
        'Stripe',
        session.id
      );
    }

    // Stripe expects a 200 response
    return createResponse(true, 'Webhook feldolgozva: ' + event.type);
  } catch (error) {
    logError('handleStripeWebhook', error);
    return createResponse(false, 'Webhook hiba: ' + error.message);
  }
}

function updatePendingBookingStatus(email, status) {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var pendingSheet = ss.getSheetByName('PendingBookings');
  if (!pendingSheet) return;

  var data = pendingSheet.getDataRange().getValues();
  // Search from the bottom so we update the most recent pending entry
  for (var i = data.length - 1; i >= 1; i--) {
    if (data[i][2] === email && data[i][12] === 'pending') {
      pendingSheet.getRange(i + 1, 13).setValue(status);
      Logger.log('Updated pending booking for ' + email + ' to ' + status);
      break;
    }
  }
}

// ============================================
// Availability Check, Error Logging & HTML Email
// ============================================
function isTimeSlotAvailable(dateStr, timeStr) {
  var calendar = CalendarApp.getDefaultCalendar();
  var start = new Date(dateStr + 'T' + timeStr + ':00');
  // 15-min buffer before + 75-min after (60-min massage + 15-min cleanup)
  var searchStart = new Date(start.getTime() - (15 * 60 * 1000));
  var searchEnd   = new Date(start.getTime() + (75 * 60 * 1000));
  var events = calendar.getEvents(searchStart, searchEnd);
  return events.length === 0;
}

function logError(context, error) {
  try {
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    var sheet = ss.getSheetByName(SHEETS.LOGS);
    if (!sheet) {
      sheet = ss.insertSheet(SHEETS.LOGS);
      sheet.appendRow(['Id≈ëpont', 'Helysz√≠n', 'Hiba√ºzenet']);
      sheet.getRange(1, 1, 1, 3).setFontWeight('bold');
    }
    sheet.appendRow([new Date(), context, error.toString()]);
  } catch (logErr) {
    Logger.log('logError failed: ' + logErr);
  }
  Logger.log('[' + context + '] ' + error);
}

function buildCustomerConfirmationHtml(data, recurringCount, recurringType, recurringDates, discountPercent, packageId, customer) {
  var primaryColor = '#D4854A';
  var html = '<div style="font-family:Arial,sans-serif;max-width:600px;margin:0 auto;border:1px solid #e0d6c8;border-radius:12px;overflow:hidden;">';

  // Price calculations
  var servicePricePerSession = (data.service && data.service.toLowerCase().indexOf('arany') !== -1) ? 30000 : 15000;
  var totalServicePrice = servicePricePerSession * recurringCount;
  var discountAmount = discountPercent > 0 ? Math.round(totalServicePrice * discountPercent / 100) : 0;
  var discountedTotal = totalServicePrice - discountAmount;
  var depositPaid = data.amount ? Math.round(data.amount) : Math.round(discountedTotal * 0.2);
  var remainingAmount = discountedTotal - depositPaid;

  // Header
  html += '<div style="background:' + primaryColor + ';padding:24px;text-align:center;">';
  html += '<h1 style="color:white;margin:0;font-size:24px;">&#10003; Sikeres Foglal√°s!</h1>';
  html += '<p style="color:rgba(255,255,255,0.9);margin:8px 0 0;">Dunakeszi Massz√°zs - Angyali Szalon</p>';
  html += '</div>';

  // Body
  html += '<div style="padding:24px;background:#fdfaf7;">';
  html += '<p>Kedves <b>' + data.name + '</b>!</p>';
  html += '<p>K√∂sz√∂n√∂m az id≈ëpontfoglal√°sodat! Az al√°bbiakban tal√°lod a foglal√°sod r√©szleteit:</p>';

  // Details box
  html += '<div style="background:white;border:1px solid #e0d6c8;border-radius:8px;padding:16px;margin:16px 0;">';
  html += '<p style="margin:6px 0;">&#128134; <b>Kezel√©s:</b> ' + data.service + '</p>';

  if (recurringCount > 1) {
    html += '<p style="margin:6px 0;">&#128197; <b>Els≈ë d√°tum:</b> ' + data.date + '</p>';
    html += '<p style="margin:6px 0;">&#8987; <b>Id≈ëpont:</b> ' + data.time + '</p>';
    html += '<p style="margin:6px 0;">&#128260; <b>Ism√©tl≈ëd√©s:</b> ' + getRecurringTypeText(recurringType) + '</p>';
    html += '<p style="margin:6px 0;">&#128202; <b>Alkalmak sz√°ma:</b> ' + recurringCount + '</p>';
    html += '<hr style="border:none;border-top:1px solid #e0d6c8;margin:12px 0;">';
    html += '<p style="margin:6px 0;"><b>&#128203; √ñsszes foglalt id≈ëpont:</b></p>';
    for (var k = 0; k < recurringDates.length; k++) {
      html += '<p style="margin:4px 0 4px 16px;">' + (k + 1) + '. ' + recurringDates[k] + ' ' + data.time + '</p>';
    }
  } else {
    html += '<p style="margin:6px 0;">&#128197; <b>D√°tum:</b> ' + data.date + '</p>';
    html += '<p style="margin:6px 0;">&#8987; <b>Id≈ëpont:</b> ' + data.time + '</p>';
  }
  html += '</div>';

  // Price breakdown box
  html += '<div style="background:#fff8f0;border:1px solid #f0dcc8;border-radius:8px;padding:16px;margin:16px 0;">';
  html += '<p style="margin:0 0 10px;font-weight:bold;color:#4A3F35;">&#128176; √År√∂sszegz√©s</p>';
  if (recurringCount > 1) {
    html += '<div style="display:flex;justify-content:space-between;margin:4px 0;font-size:14px;">';
    html += '<span style="color:#8B7355;">Kezel√©s √°ra (' + recurringCount + ' √ó ' + servicePricePerSession.toLocaleString() + ' Ft):</span>';
    html += '<span style="color:#4A3F35;font-weight:500;">' + totalServicePrice.toLocaleString() + ' Ft</span></div>';
  } else {
    html += '<div style="display:flex;justify-content:space-between;margin:4px 0;font-size:14px;">';
    html += '<span style="color:#8B7355;">Kezel√©s √°ra:</span>';
    html += '<span style="color:#4A3F35;font-weight:500;">' + servicePricePerSession.toLocaleString() + ' Ft</span></div>';
  }
  if (discountPercent > 0) {
    html += '<div style="display:flex;justify-content:space-between;margin:4px 0;font-size:14px;">';
    html += '<span style="color:#8B9A7C;">Kedvezm√©ny (' + discountPercent + '%):</span>';
    html += '<span style="color:#8B9A7C;">-' + discountAmount.toLocaleString() + ' Ft</span></div>';
    html += '<div style="display:flex;justify-content:space-between;margin:4px 0 8px;font-size:14px;border-top:1px solid #e0d6c8;padding-top:8px;">';
    html += '<span style="color:#4A3F35;font-weight:bold;">√ñsszesen:</span>';
    html += '<span style="color:#4A3F35;font-weight:bold;">' + discountedTotal.toLocaleString() + ' Ft</span></div>';
  }
  if (!packageId) {
    html += '<div style="display:flex;justify-content:space-between;margin:4px 0;font-size:14px;background:#e8f5e9;padding:6px 8px;border-radius:4px;">';
    html += '<span style="color:#2e7d32;">&#10003; Befizetett foglal√≥ (20%):</span>';
    html += '<span style="color:#2e7d32;font-weight:bold;">' + depositPaid.toLocaleString() + ' Ft</span></div>';
    html += '<div style="display:flex;justify-content:space-between;margin:4px 0;font-size:14px;background:#fff3e0;padding:6px 8px;border-radius:4px;">';
    html += '<span style="color:#e65100;">&#128197; H√°tral√©k (kezel√©skor fizetend≈ë):</span>';
    html += '<span style="color:#e65100;font-weight:bold;">' + remainingAmount.toLocaleString() + ' Ft</span></div>';
  } else {
    html += '<div style="margin:4px 0;font-size:14px;color:#4A7C59;font-weight:500;">&#127903; B√©rletb≈ël felhaszn√°lva</div>';
  }
  html += '</div>';

  if (customer && customer.totalSessionsRemaining > 0) {
    html += '<div style="background:#e8f5e9;border-radius:8px;padding:12px;margin:12px 0;">';
    html += '<p style="margin:0;">&#127903; <b>B√©rlet egyenleg:</b> ' + customer.totalSessionsRemaining + ' alkalom</p>';
    html += '</div>';
  }

  // Address
  html += '<div style="background:#fff3e0;border-radius:8px;padding:12px;margin:12px 0;">';
  html += '<p style="margin:0 0 6px;"><b>&#128205; C√≠m √©s megk√∂zel√≠t√©s:</b></p>';
  html += '<p style="margin:4px 0;">Dunakeszi, Kolonics Gy√∂rgy utca 2/B, 2120</p>';
  html += '<p style="margin:4px 0;">Kapucseng≈ë: <b>1/43</b></p>';
  html += '</div>';

  html += '<div style="background:#EFF6FF;border:1px solid #BFDBFE;border-radius:8px;padding:16px;margin:16px 0;">';
  html += '<p style="margin:0 0 10px;font-size:14px;color:#1D4ED8;font-weight:bold;">&#128197; Szeretned m√≥dos√≠tani vagy lemondani egy id≈ëpontot?</p>';
  html += '<p style="margin:0 0 10px;font-size:13px;color:#374151;">Ezt k√∂nnyen meg tudod tenni online, b√°rmikor:</p>';
  html += '<ol style="margin:0 0 12px;padding-left:20px;font-size:13px;color:#374151;line-height:2;">';
  html += '<li>Kattints az al√°bbi gombra</li>';
  html += '<li>√çd be <b>' + data.email + '</b> c√≠med</li>';
  html += '<li>Megjelennek az √∂sszes k√∂zelg≈ë foglal√°said</li>';
  html += '<li>Minden alkalom mell√© tal√°lsz <b>M√≥dos√≠t√°s</b> √©s <b>Lemond√°s</b> gombot</li>';
  html += '</ol>';
  html += '<div style="text-align:center;margin:12px 0 8px;">';
  html += '<a href="https://dunakeszimasszazs.hu/#foglalaskezeles" style="display:inline-block;background:#D4854A;color:white;text-decoration:none;padding:12px 28px;border-radius:20px;font-size:14px;font-weight:bold;">Foglal√°saim kezel√©se &rarr;</a>';
  html += '</div>';
  html += '<p style="margin:8px 0 0;font-size:11px;color:#6B7280;text-align:center;">&#9888;&#65039; Ingyenes lemondas / m√≥dos√≠t√°s k√©r√©s 24 √≥r√°val az alkalom el≈ëtt lehetk√©rni</p>';
  html += '</div>';

  html += '<p style="font-size:13px;color:#666;">Ha k√©rd√©sed van, h√≠vj b√°tran: <b>+36 30 487 7883</b></p>';
  html += '<p style="font-size:13px;color:#666;">V√°rlak szeretettel az Angyali Szalonban!</p>';
  html += '</div>';

  // Footer strip
  html += '<div style="background:#f5ede3;padding:12px;text-align:center;font-size:12px;color:#888;">';
  html += 'Makra Edina &middot; Dunakeszi Massz√°zs &middot; <a href="https://dunakeszimasszazs.hu" style="color:#D4854A;">dunakeszimasszazs.hu</a>';
  html += '</div>';

  html += '</div>';
  return html;
}

// ============================================
// Helper Functions
// ============================================
function createResponse(success, message, data) {
  var response = { success: success, message: message };
  if (data) { response.data = data; }
  
  var output = ContentService.createTextOutput(JSON.stringify(response));
  output.setMimeType(ContentService.MimeType.JSON);
  return output;
}

function createHtmlResponse(html) {
  var output = ContentService.createTextOutput(html);
  output.setMimeType(ContentService.MimeType.HTML);
  return output;
}

// Timezone for all user-facing date/time formatting
var TZ = 'Europe/Budapest';

// In-memory set of booking keys created in THIS script execution.
// GAS caches sheet reads within a single execution ‚Äî appendRow+flush() does NOT
// invalidate the read cache, so dupData reads would return stale (pre-write) data.
// This set is the ground truth for same-execution duplicate detection.
// Key format: "customerId|YYYY-MM-DD|HH:MM"
var _createdBookingKeys = {};

// Format a JS Date as YYYY-MM-DD in Budapest time
function formatDate(date) {
  return Utilities.formatDate(date, TZ, 'yyyy-MM-dd');
}

// Safely extract HH:MM from a sheet cell value.
// Google Sheets stores time-typed cells as Date objects (Dec 30 1899 HH:MM:SS).
// This handles both that case and plain strings like "09:45" or "09:45:00".
function formatTimeFromSheet(val) {
  if (!val && val !== 0) return '';
  if (val instanceof Date) {
    return String(val.getHours()).padStart(2, '0') + ':' + String(val.getMinutes()).padStart(2, '0');
  }
  // String ‚Äî take first 5 chars ("HH:MM")
  return String(val).slice(0, 5);
}

function getRecurringTypeText(type) {
  switch(type) {
    case 'weekly': return 'Minden h√©ten';
    case 'biweekly': return 'K√©thetente';
    case 'monthly': return 'Minden h√≥napban';
    default: return type;
  }
}

function calculateDiscount(sessionCount) {
  if (sessionCount >= 6) return 15;
  if (sessionCount >= 4) return 10;
  if (sessionCount >= 2) return 5;
  return 0;
}

// ============================================
// SYSTEM TEST RUNNER
// Run manually from the Apps Script editor (NOT deployed).
// Tests every backend feature. Creates [TEST] tagged data,
// runs all checks, then cleans itself up automatically.
// NOTE: Stripe checkout is intentionally NOT tested here
//       (live keys are active ‚Äì never test Stripe from GAS directly).
// Test notification emails will be sent to Edina with [TEST] in the name.
// ============================================
function runSystemTests() {
  var TAG = '[TEST]';
  var testEmail = 'dunakeszimasszor@gmail.com'; // test emails land here
  var testName  = TAG + ' Auto Teszt';
  var testPhone = '+36 99 000 0000';
  var testService = 'Friss√≠t≈ë massz√°zs';

  // Dates: 3 and 4 days from now (safely outside 24h restriction)
  var d3 = new Date(); d3.setDate(d3.getDate() + 3);
  var d4 = new Date(); d4.setDate(d4.getDate() + 4);
  var dateA = formatDate(d3); // used for single + duplicate tests
  var dateB = formatDate(d4); // used for recurring test
  var timeA = '10:00';
  var timeB = '11:15';
  var timeC = '14:00'; // used for change-request target

  // Date within 24h for policy enforcement test (2h from now)
  var dSoon = new Date(); dSoon.setHours(dSoon.getHours() + 2);
  var date24h = formatDate(dSoon);
  var time24h = String(dSoon.getHours()).padStart(2,'0') + ':' + String(dSoon.getMinutes()).padStart(2,'0');

  var passed = 0, failed = 0, skipped = 0;
  var log = [];

  function pass(name)          { passed++;  log.push('‚úÖ PASS: ' + name);  Logger.log('PASS: ' + name); }
  function fail(name, detail)  { failed++;  log.push('‚ùå FAIL: ' + name + '\n       ‚Üí ' + detail); Logger.log('FAIL: ' + name + ' ‚Äì ' + detail); }
  function skip(name, reason)  { skipped++; log.push('‚è≠Ô∏è  SKIP: ' + name + ' (' + reason + ')'); }

  // Safely parse response ‚Äî functions return plain objects via createResponse()
  function r(resp) {
    if (!resp) return { success: false, message: 'null response' };
    if (typeof resp === 'object' && 'success' in resp) return resp;
    try { return JSON.parse(resp.getContent ? resp.getContent() : resp); } catch(e) { return { success: false, message: 'parse error: ' + e }; }
  }

  log.push('‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');
  log.push('‚ïë  DUNAKESZI MASSZ√ÅZS ‚Äì RENDSZERTESZT      ‚ïë');
  log.push('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù');
  log.push('Futtatva: ' + new Date().toLocaleString('hu-HU'));
  log.push('Teszt d√°tum A: ' + dateA + ' ' + timeA);
  log.push('Teszt d√°tum B: ' + dateB + ' ' + timeA + ' (ism√©tl≈ëd≈ë)');
  log.push('24h teszt: ' + date24h + ' ' + time24h);
  log.push('');

  // ‚îÄ‚îÄ 1. V√°s√°rl√≥ l√©trehoz√°s ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  var testCustomerId;
  try {
    var c1 = getOrCreateCustomer(testName, testEmail, testPhone);
    if (c1 && c1.customerId) { testCustomerId = c1.customerId; pass('1. V√°s√°rl√≥ l√©trehoz√°s'); }
    else { fail('1. V√°s√°rl√≥ l√©trehoz√°s', JSON.stringify(c1)); }
  } catch(e) { fail('1. V√°s√°rl√≥ l√©trehoz√°s', e.toString()); }

  // ‚îÄ‚îÄ 2. Duplik√°lt v√°s√°rl√≥ megel≈ëz√©s ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  try {
    var c2 = getOrCreateCustomer(testName, testEmail, testPhone);
    if (c2 && c2.customerId === testCustomerId) { pass('2. Duplik√°lt v√°s√°rl√≥ megel≈ëz√©s (ugyanaz az ID)'); }
    else { fail('2. Duplik√°lt v√°s√°rl√≥ megel≈ëz√©s', 'K√ºl√∂nb√∂z≈ë ID: ' + (c2 ? c2.customerId : 'null')); }
  } catch(e) { fail('2. Duplik√°lt v√°s√°rl√≥ megel≈ëz√©s', e.toString()); }

  // ‚îÄ‚îÄ 3. Egyszeri foglal√°s l√©trehoz√°s ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  try {
    var r3 = r(createBooking({ name: testName, email: testEmail, phone: testPhone,
      service: testService, date: dateA, time: timeA, recurring: 'no', recurringCount: '1', notes: TAG }));
    if (r3.success) { pass('3. Egyszeri foglal√°s l√©trehoz√°s'); }
    else { fail('3. Egyszeri foglal√°s l√©trehoz√°s', r3.message); }
  } catch(e) { fail('3. Egyszeri foglal√°s l√©trehoz√°s', e.toString()); }

  // ‚îÄ‚îÄ 4. Duplik√°lt id≈ëpont megel≈ëz√©s ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  try {
    var r4 = r(createBooking({ name: testName, email: testEmail, phone: testPhone,
      service: testService, date: dateA, time: timeA, recurring: 'no', recurringCount: '1', notes: TAG }));
    if (!r4.success && r4.message && r4.message.indexOf('m√°r van') !== -1) { pass('4. Duplik√°lt id≈ëpont megel≈ëz√©s'); }
    else { fail('4. Duplik√°lt id≈ëpont megel≈ëz√©s', 'El kellett volna utas√≠tani. Kapott: ' + JSON.stringify(r4)); }
  } catch(e) { fail('4. Duplik√°lt id≈ëpont megel≈ëz√©s', e.toString()); }

  // ‚îÄ‚îÄ 5. Ism√©tl≈ëd≈ë foglal√°s + automatikus b√©rlet ‚îÄ‚îÄ‚îÄ‚îÄ
  try {
    var r5 = r(createBooking({ name: testName, email: testEmail, phone: testPhone,
      service: testService, date: dateB, time: timeA, recurring: 'yes', recurringCount: '3', recurringType: 'weekly', notes: TAG }));
    if (r5.success) {
      var pkgs5 = r(getAllPackages_());
      var myPkgs = (pkgs5.data && pkgs5.data.packages ? pkgs5.data.packages : [])
        .filter(function(p) { return p.customerName === testName && Number(p.sessionsPurchased) === 3; });
      if (myPkgs.length > 0) { pass('5. Ism√©tl≈ëd≈ë foglal√°s (3 alkalom) + automatikus b√©rlet l√©trehoz√°s'); }
      else { fail('5. Automatikus b√©rlet l√©trehoz√°s', 'B√©rlet nem jelent meg a SessionPackages-ben'); }
    } else { fail('5. Ism√©tl≈ëd≈ë foglal√°s l√©trehoz√°s', r5.message); }
  } catch(e) { fail('5. Ism√©tl≈ëd≈ë foglal√°s + automatikus b√©rlet', e.toString()); }

  // ‚îÄ‚îÄ 6. Saj√°t foglal√°sok lek√©r√©se (d√°tum form√°tum) ‚îÄ
  var myBookingsData;
  try {
    var r6 = r(getMyBookings_(testEmail));
    if (r6.success && r6.data && r6.data.bookings) {
      myBookingsData = r6.data.bookings;
      var allDates = myBookingsData.every(function(b) { return /^\d{4}-\d{2}-\d{2}$/.test(b.date); });
      var allTimes = myBookingsData.every(function(b) { return /^\d{2}:\d{2}$/.test(b.time); });
      if (myBookingsData.length > 0 && allDates && allTimes) { pass('6. Saj√°t foglal√°sok (helyes YYYY-MM-DD d√°tum, HH:MM id≈ë ‚Äì ' + myBookingsData.length + ' db)'); }
      else { fail('6. Saj√°t foglal√°sok form√°tum', 'dates ok=' + allDates + ' times ok=' + allTimes + ' count=' + myBookingsData.length); }
    } else { fail('6. Saj√°t foglal√°sok lek√©r√©se', r6.message); }
  } catch(e) { fail('6. Saj√°t foglal√°sok lek√©r√©se', e.toString()); }

  // ‚îÄ‚îÄ 7. √ñsszes foglal√°s lek√©r√©se (admin) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  try {
    var r7 = r(getAllBookings_());
    if (r7.success && r7.data && r7.data.bookings) {
      var mine7 = r7.data.bookings.filter(function(b) { return b.customerName === testName; });
      var datesOk = mine7.every(function(b) { return /^\d{4}-\d{2}-\d{2}$/.test(b.date); });
      var timesOk = mine7.every(function(b) { return /^\d{2}:\d{2}$/.test(b.time); });
      var createdOk = mine7.every(function(b) { return b.createdDate && b.createdDate.length >= 8; });
      if (mine7.length > 0 && datesOk && timesOk && createdOk) { pass('7. √ñsszes foglal√°s (helyes d√°tum/id≈ë/l√©trehozva form√°tum ‚Äì ' + mine7.length + ' db)'); }
      else { fail('7. √ñsszes foglal√°s form√°tum', 'dates=' + datesOk + ' times=' + timesOk + ' created=' + createdOk + ' count=' + mine7.length); }
    } else { fail('7. √ñsszes foglal√°s lek√©r√©se', r7.message); }
  } catch(e) { fail('7. √ñsszes foglal√°s lek√©r√©se', e.toString()); }

  // ‚îÄ‚îÄ 8. B√©rletek lek√©r√©se ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  try {
    var r8 = r(getAllPackages_());
    if (r8.success && r8.data && r8.data.packages) {
      var myPkgs8 = r8.data.packages.filter(function(p) { return p.customerName === testName; });
      if (myPkgs8.length > 0) { pass('8. B√©rletek lek√©r√©se (' + myPkgs8.length + ' teszt b√©rlet)'); }
      else { fail('8. B√©rletek lek√©r√©se', 'Nincs b√©rlet a teszt v√°s√°rl√≥ nev√©n'); }
    } else { fail('8. B√©rletek lek√©r√©se', r8.message); }
  } catch(e) { fail('8. B√©rletek lek√©r√©se', e.toString()); }

  // ‚îÄ‚îÄ 9. Saj√°t lemond√°s ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  var confirmedBefore9 = myBookingsData ? myBookingsData.filter(function(b) { return b.status === 'Confirmed'; }) : [];
  if (confirmedBefore9.length > 0) {
    try {
      var r9 = r(selfCancelBooking_({ bookingId: confirmedBefore9[0].bookingId, email: testEmail, reason: 'Automatikus teszt' }));
      if (r9.success) { pass('9. Saj√°t foglal√°s lemond√°s'); }
      else { fail('9. Saj√°t foglal√°s lemond√°s', r9.message); }
    } catch(e) { fail('9. Saj√°t foglal√°s lemond√°s', e.toString()); }
  } else { skip('9. Saj√°t foglal√°s lemond√°s', 'Nincs Confirmed foglal√°s'); }

  // ‚îÄ‚îÄ 10. 24 √≥r√°s szab√°ly √©rv√©nyes√≠t√©s ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  try {
    var r10c = r(createBooking({ name: testName, email: testEmail, phone: testPhone,
      service: testService, date: date24h, time: time24h, recurring: 'no', recurringCount: '1', notes: TAG + '_24H' }));
    if (r10c.success) {
      // Use the bookingId returned directly ‚Äî avoids stale sheet read cache
      var bid10 = (r10c.data && r10c.data.bookingIds && r10c.data.bookingIds.length > 0) ? r10c.data.bookingIds[0] : null;
      if (bid10) {
        var r10 = r(selfCancelBooking_({ bookingId: bid10, email: testEmail, reason: 'teszt' }));
        if (!r10.success && r10.message && r10.message.indexOf('24') !== -1) { pass('10. 24 √≥r√°s lemond√°si szab√°ly √©rv√©nyes√≠t√©s'); }
        else { fail('10. 24 √≥r√°s lemond√°si szab√°ly', 'El kellett volna utas√≠tani 24h √ºzenettel. Kapott: ' + JSON.stringify(r10)); }
      } else { skip('10. 24 √≥r√°s lemond√°si szab√°ly', '24h-s bookingId nem √©rhet≈ë el a v√°laszban'); }
    } else { skip('10. 24 √≥r√°s lemond√°si szab√°ly', 'Nem siker√ºlt k√∂zeli foglal√°st l√©trehozni: ' + r10c.message); }
  } catch(e) { fail('10. 24 √≥r√°s lemond√°si szab√°ly', e.toString()); }

  // Force-cancel any near-term (<25h) [TEST] booking so it doesn't become confirmed11[0]
  try {
    var bSh10 = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEETS.BOOKINGS);
    var bD10 = bSh10.getDataRange().getValues();
    for (var bi10 = bD10.length - 1; bi10 >= 1; bi10--) {
      if (String(bD10[bi10][2]).indexOf(TAG) !== -1 && bD10[bi10][6] === 'Confirmed') {
        var rowDate10 = typeof bD10[bi10][4] === 'string' ? bD10[bi10][4].slice(0,10) : formatDate(new Date(bD10[bi10][4]));
        var rowTime10 = formatTimeFromSheet(bD10[bi10][5]);
        var rowMs10 = new Date(rowDate10 + 'T' + rowTime10 + ':00').getTime();
        if ((rowMs10 - Date.now()) < 25 * 60 * 60 * 1000) {
          bSh10.getRange(bi10 + 1, 7).setValue('Cancelled');
        }
      }
    }
    SpreadsheetApp.flush();
  } catch(e10c) { Logger.log('Near-term test cleanup skipped: ' + e10c); }

  // ‚îÄ‚îÄ 11. M√≥dos√≠t√°si k√©relem ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  var freshBookings11;
  try {
    var mb11 = r(getMyBookings_(testEmail));
    freshBookings11 = mb11.data && mb11.data.bookings ? mb11.data.bookings : [];
    // Only pick a booking safely >25h in the future to avoid 24h policy rejection
    var now11 = Date.now();
    var confirmed11 = freshBookings11.filter(function(b) {
      return b.status === 'Confirmed' &&
             (new Date(b.date + 'T' + b.time + ':00').getTime() - now11) > 25 * 60 * 60 * 1000;
    });
    if (confirmed11.length > 0) {
      var d5 = new Date(); d5.setDate(d5.getDate() + 5);
      var r11 = r(selfRequestChange_({ bookingId: confirmed11[0].bookingId, email: testEmail, newDate: formatDate(d5), newTime: timeC, notes: 'teszt m√≥dos√≠t√°s' }));
      if (r11.success) { pass('11. M√≥dos√≠t√°si k√©relem k√ºld√©s + ChangeRequested st√°tusz'); }
      else { fail('11. M√≥dos√≠t√°si k√©relem', r11.message); }
    } else { skip('11. M√≥dos√≠t√°si k√©relem', 'Nincs >25h j√∂v≈ëbeli Confirmed foglal√°s'); }
  } catch(e) { fail('11. M√≥dos√≠t√°si k√©relem', e.toString()); }

  // ‚îÄ‚îÄ 12. √útk√∂z≈ë m√≥dos√≠t√°s megel≈ëz√©s ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  try {
    var mb12 = r(getMyBookings_(testEmail));
    var all12 = mb12.data && mb12.data.bookings ? mb12.data.bookings : [];
    var now12 = Date.now();
    var conf12 = all12.filter(function(b) {
      return b.status === 'Confirmed' &&
             (new Date(b.date + 'T' + b.time + ':00').getTime() - now12) > 25 * 60 * 60 * 1000;
    });
    var others12 = all12.filter(function(b) {
      return (b.status === 'Confirmed' || b.status === 'ChangeRequested') &&
             (new Date(b.date + 'T' + b.time + ':00').getTime() - now12) > 25 * 60 * 60 * 1000;
    });
    var target12 = others12.find(function(b) { return conf12.length > 0 && b.bookingId !== conf12[0].bookingId; });
    if (conf12.length > 0 && target12) {
      var r12 = r(selfRequestChange_({ bookingId: conf12[0].bookingId, email: testEmail, newDate: target12.date, newTime: target12.time, notes: '√ºtk√∂z√©s teszt' }));
      if (!r12.success && r12.message && r12.message.indexOf('m√°r van') !== -1) { pass('12. √útk√∂z≈ë m√≥dos√≠t√°s megel≈ëz√©s'); }
      else { fail('12. √útk√∂z≈ë m√≥dos√≠t√°s megel≈ëz√©s', 'El kellett volna utas√≠tani. Kapott: ' + JSON.stringify(r12)); }
    } else { skip('12. √útk√∂z≈ë m√≥dos√≠t√°s megel≈ëz√©s', 'Nincs el√©g j√∂v≈ëbeli foglal√°s az √ºtk√∂z√©s tesztel√©s√©hez (conf=' + conf12.length + ' others=' + others12.length + ')'); }
  } catch(e) { fail('12. √útk√∂z≈ë m√≥dos√≠t√°s megel≈ëz√©s', e.toString()); }

  // ‚îÄ‚îÄ 13. B√©rlet alkalom levon√°s ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  try {
    var r13all = r(getAllPackages_());
    var pkg13 = (r13all.data && r13all.data.packages ? r13all.data.packages : [])
      .find(function(p) { return p.customerName === testName && p.status === 'Active' && Number(p.sessionsRemaining) > 0; });
    if (pkg13) {
      var before13 = Number(pkg13.sessionsRemaining);
      var rd13 = deductSessionFromPackage(pkg13.packageId);
      var r13all2 = r(getAllPackages_());
      var updated13 = (r13all2.data && r13all2.data.packages ? r13all2.data.packages : [])
        .find(function(p) { return p.packageId === pkg13.packageId; });
      if (updated13 && Number(updated13.sessionsRemaining) === before13 - 1) { pass('13. B√©rlet alkalom levon√°s (' + before13 + ' ‚Üí ' + updated13.sessionsRemaining + ' maradt)'); }
      else { fail('13. B√©rlet alkalom levon√°s', 'V√°rt: ' + (before13-1) + ' Kapott: ' + (updated13 ? updated13.sessionsRemaining : 'n/a')); }
    } else { skip('13. B√©rlet alkalom levon√°s', 'Nincs akt√≠v b√©rlet'); }
  } catch(e) { fail('13. B√©rlet alkalom levon√°s', e.toString()); }

  // ‚îÄ‚îÄ 14. Szabad id≈ëpont ellen≈ërz√©s (napt√°r) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  try {
    var freeDate = new Date(); freeDate.setDate(freeDate.getDate() + 60);
    var avail = isTimeSlotAvailable(formatDate(freeDate), '03:00');
    if (avail === true) { pass('14. Szabad id≈ëpont ellen≈ërz√©s (60 nap m√∫lva 03:00 ‚Üí szabad)'); }
    else { fail('14. Szabad id≈ëpont ellen≈ërz√©s', 'Val√≥sz√≠n≈±leg szabad id≈ëpont foglaltk√©nt jelent meg'); }
  } catch(e) { fail('14. Szabad id≈ëpont ellen≈ërz√©s (napt√°r)', e.toString()); }

  // ‚îÄ‚îÄ 15. ChangeRequested foglal√°s megjelenik a list√°n ‚îÄ
  try {
    var mb15 = r(getMyBookings_(testEmail));
    var cr15 = (mb15.data && mb15.data.bookings ? mb15.data.bookings : []).filter(function(b) { return b.status === 'ChangeRequested'; });
    if (cr15.length > 0) { pass('15. ChangeRequested foglal√°s megjelenik az √ºgyf√©l list√°j√°ban'); }
    else { skip('15. ChangeRequested st√°tusz l√°that√≥s√°g', 'Nincs ChangeRequested st√°tusz√∫ foglal√°s (teszt 11 sikertelen volt?)'); }
  } catch(e) { fail('15. ChangeRequested st√°tusz l√°that√≥s√°g', e.toString()); }

  // ‚îÄ‚îÄ CLEANUP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  var cleanedRows = 0, cleanedCal = 0;
  try {
    var ss = SpreadsheetApp.getActiveSpreadsheet();

    // Bookings sheet
    var bSh = ss.getSheetByName(SHEETS.BOOKINGS);
    var bD = bSh.getDataRange().getValues();
    for (var bi = bD.length - 1; bi >= 1; bi--) {
      if (String(bD[bi][2]).indexOf(TAG) !== -1) { bSh.deleteRow(bi + 1); cleanedRows++; }
    }
    // SessionPackages sheet
    var pSh = ss.getSheetByName(SHEETS.SESSION_PACKAGES);
    var pD = pSh.getDataRange().getValues();
    for (var pi = pD.length - 1; pi >= 1; pi--) {
      if (String(pD[pi][2]).indexOf(TAG) !== -1) { pSh.deleteRow(pi + 1); cleanedRows++; }
    }
    // Customers sheet
    var cSh = ss.getSheetByName(SHEETS.CUSTOMERS);
    var cD = cSh.getDataRange().getValues();
    for (var ci = cD.length - 1; ci >= 1; ci--) {
      if (String(cD[ci][1]).indexOf(TAG) !== -1) { cSh.deleteRow(ci + 1); cleanedRows++; }
    }
    // Financial sheet
    var fSh = ss.getSheetByName(SHEETS.FINANCIAL);
    if (fSh) {
      var fD = fSh.getDataRange().getValues();
      for (var fi = fD.length - 1; fi >= 1; fi--) {
        if (String(fD[fi][4]).indexOf(TAG) !== -1) { fSh.deleteRow(fi + 1); cleanedRows++; }
      }
    }
    // Google Calendar events tagged [TEST]
    try {
      var cal = CalendarApp.getDefaultCalendar();
      var calFrom = new Date(); calFrom.setDate(calFrom.getDate() - 1);
      var calTo = new Date(); calTo.setDate(calTo.getDate() + 100);
      cal.getEvents(calFrom, calTo).forEach(function(ev) {
        if (ev.getTitle().indexOf(TAG) !== -1 || ev.getDescription().indexOf(TAG) !== -1) {
          ev.deleteEvent(); cleanedCal++;
        }
      });
    } catch(calE) { log.push('‚ö†Ô∏è  Napt√°r cleanup hiba: ' + calE); }

    log.push('');
    log.push('üßπ Cleanup: ' + cleanedRows + ' sor + ' + cleanedCal + ' napt√°resem√©ny t√∂r√∂lve');
  } catch(cleanE) { log.push('‚ö†Ô∏è  Cleanup hiba: ' + cleanE); }

  // ‚îÄ‚îÄ SUMMARY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  log.push('');
  log.push('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
  log.push('EREDM√âNY:  ‚úÖ ' + passed + ' PASSED  |  ‚ùå ' + failed + ' FAILED  |  ‚è≠Ô∏è  ' + skipped + ' SKIPPED');
  log.push('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');

  var fullLog = log.join('\n');
  Logger.log(fullLog);
  SpreadsheetApp.getUi().alert(
    failed === 0 ? '‚úÖ Minden teszt √°tment! (' + passed + '/' + (passed+skipped) + ')' : '‚ö†Ô∏è  ' + failed + ' teszt FAILED ‚Äì l√°sd r√©szleteket',
    fullLog,
    SpreadsheetApp.getUi().ButtonSet.OK
  );
}

// ============================================
// ONE-TIME CLEANUP ‚Äî Run manually from Apps Script editor
// Clears ALL rows (except headers) from Bookings, Customers,
// SessionPackages, Financial, PendingBookings sheets.
// Also deletes all Google Calendar events created by the system.
// DO NOT deploy this ‚Äî run it once from the editor then delete it.
// ============================================
function cleanupAllTestData() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheetsToWipe = [
    SHEETS.BOOKINGS,
    SHEETS.CUSTOMERS,
    SHEETS.SESSION_PACKAGES,
    SHEETS.FINANCIAL,
    'PendingBookings'
  ];

  var report = [];

  sheetsToWipe.forEach(function(name) {
    var sheet = ss.getSheetByName(name);
    if (!sheet) { report.push(name + ': not found, skipped'); return; }
    var lastRow = sheet.getLastRow();
    if (lastRow > 1) {
      sheet.deleteRows(2, lastRow - 1);
      report.push(name + ': deleted ' + (lastRow - 1) + ' rows');
    } else {
      report.push(name + ': already empty');
    }
  });

  // Delete all calendar events that were created by the booking system
  // (looks for events with "Massz√°zs -" in the title within the last 2 years)
  var deletedEvents = 0;
  try {
    var cal = CalendarApp.getDefaultCalendar();
    var from = new Date();
    from.setFullYear(from.getFullYear() - 2);
    var to = new Date();
    to.setFullYear(to.getFullYear() + 2);
    var events = cal.getEvents(from, to);
    events.forEach(function(ev) {
      var title = ev.getTitle();
      if (title.indexOf('Massz√°zs -') === 0) {
        ev.deleteEvent();
        deletedEvents++;
      }
    });
    report.push('Calendar: deleted ' + deletedEvents + ' events');
  } catch(e) {
    report.push('Calendar cleanup skipped: ' + e);
  }

  Logger.log('=== CLEANUP COMPLETE ===\n' + report.join('\n'));
  SpreadsheetApp.getUi().alert('Cleanup complete!\n\n' + report.join('\n'));
}

function buildEventDescription(data, sessionNum, totalSessions, packageId, sessionNumber) {
  var desc = 'Kezel√©s: ' + data.service + '\n' +
             'N√©v: ' + data.name + '\n' +
             'Telefon: ' + (data.phone || 'Nincs megadva') + '\n' +
             'Email: ' + data.email + '\n' +
             'Megjegyz√©s: ' + (data.notes || 'Nincs megadva') + '\n';
  
  if (totalSessions > 1) {
    desc += 'Alkalom: ' + sessionNum + '/' + totalSessions + '\n';
  }
  
  if (packageId) {
    desc += 'B√©rlet: ' + packageId + '\n';
    desc += 'B√©rlet alkalmak: ' + sessionNumber + '\n';
  }
  
  return desc;
}
